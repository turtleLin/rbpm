<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="bootstrap.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="navbar">
            <div class="navbar-inner">
                <div class="container">
                    <span class="brand"> Test Coverage</span>
                    <ul class="nav">
                        <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="#lib">./lib (41%)</a></li><li><a href="#lib-adapters">./lib/adapters (48%)</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="span6" style="margin-top: 10px;">
                        <div class="progress progress-warning"> <div class="bar" style="width: 43%"><strong>43%</strong> [667/1541]</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="group-header row" id="lib"><div class="group-name span5">./lib</div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 41%"><strong>41%</strong> [448/1081]</div></div></div></div><div id="lib-abstract-class-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-abstract-class-js" class="filename trigger" name="lib-abstract-class-js">lib/abstract-class.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 35%"><strong>35%</strong> [167/482]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> util = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./utils'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> helpers = utils.helpers;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Query = <span class="func">require</span>(<span class="S">'./query'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Validatable = <span class="func">require</span>(<span class="S">'./validatable'</span>).Validatable;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> List = <span class="func">require</span>(<span class="S">'./list'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Hookable = <span class="func">require</span>(<span class="S">'./hookable'</span>).Hookable;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> DEFAULT_CACHE_LIMIT = 1000;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> BASE_TYPES = <span class="gly">[</span><span class="S">'String'</span>, <span class="S">'Boolean'</span>, <span class="S">'Number'</span>, <span class="S">'Date'</span>, <span class="S">'Text'</span>, <span class="S">'JSON'</span><span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.AbstractClass = AbstractClass;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">if</span> (!Object.<span class="kwrd">prototype</span>.<span class="func">hasOwnProperty</span>(<span class="S">'extend'</span>)) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(Object.<span class="kwrd">prototype</span>, <span class="S">"extend"</span>, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        value: <span class="kwrd">function</span> (from) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> props = Object.<span class="func">getOwnPropertyNames</span>(from);</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> dest = this;</code></li><li class=""><code>            props.<span class="func">forEach</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (name <span class="kwrd">in</span> dest) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> destination = Object.<span class="func">getOwnPropertyDescriptor</span>(from, name);</code></li><li class="uncovered"><code>                    Object.<span class="func">defineProperty</span>(dest, name, destination);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>AbstractClass.__proto__ = Validatable;</code><span class="hits">1</span></li><li class="covered"><code>AbstractClass.<span class="kwrd">prototype</span>.__proto__ = Validatable.<span class="kwrd">prototype</span>;</code><span class="hits">1</span></li><li class="covered"><code>utils.<span class="func">inherits</span>(AbstractClass, Hookable);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Abstract class - base class for all persist objects</span></code></li><li class=""><code><span class="C"> * provides **common API** to access any database adapter.</span></code></li><li class=""><code><span class="C"> * This class describes only abstract behavior layer, refer to `lib/adapters/*.js`</span></code></li><li class=""><code><span class="C"> * to learn more about specific adapter implementations</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * `AbstractClass` mixes `Validatable` and `Hookable` classes methods</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @constructor</span></code></li><li class=""><code><span class="C"> * @param {Object} data - initial object data</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">AbstractClass</span>(data) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">_initProperties</span>(data, true);</code><span class="hits">18</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>._initProperties = <span class="kwrd">function</span> (data, applySetters) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="kwrd">var</span> ctor = this.constructor;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="kwrd">var</span> ds = ctor.schema.definitions<span class="gly">[</span>ctor.modelName<span class="gly">]</span>;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="kwrd">var</span> properties = ds.properties;</code><span class="hits">26</span></li><li class="covered"><code>    data = data <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'__cachedRelations'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: true,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="gly">{</span><span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'__data'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: true,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="gly">{</span><span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'__query'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: true,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="gly">{</span><span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'__dataWas'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: true,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="gly">{</span><span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (data<span class="gly">[</span><span class="S">'__cachedRelations'</span><span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.__cachedRelations = data<span class="gly">[</span><span class="S">'__cachedRelations'</span><span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> data) <span class="gly">{</span></code></li><li class="covered"><code>        this.__data<span class="gly">[</span>i<span class="gly">]</span> = this.__dataWas<span class="gly">[</span>i<span class="gly">]</span> = data<span class="gly">[</span>i<span class="gly">]</span>;</code><span class="hits">52</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (applySetters &amp;&amp; ctor.setter) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(ctor.setter).<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (self.__data.<span class="func">hasOwnProperty</span>(attr)) <span class="gly">{</span></code></li><li class="uncovered"><code>                ctor.setter<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">call</span>(self, self.__data<span class="gly">[</span>attr<span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">18</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    ctor.<span class="func">forEachProperty</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!self.__data.<span class="func">hasOwnProperty</span>(attr)) <span class="gly">{</span></code></li><li class="covered"><code>            self.__data<span class="gly">[</span>attr<span class="gly">]</span> = self.__dataWas<span class="gly">[</span>attr<span class="gly">]</span> = <span class="func">getDefault</span>(attr);</code><span class="hits">126</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            self.__dataWas<span class="gly">[</span>attr<span class="gly">]</span> = self.__data<span class="gly">[</span>attr<span class="gly">]</span>;</code><span class="hits">52</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    ctor.<span class="func">forEachProperty</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> type = properties<span class="gly">[</span>attr<span class="gly">]</span>.type;</code><span class="hits">178</span></li><li class=""><code>        <span class="kwrd">if</span> (BASE_TYPES.<span class="func">indexOf</span>(type.name) === -1) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> self.__data<span class="gly">[</span>attr<span class="gly">]</span> !== <span class="S">'object'</span> &amp;&amp; self.__data<span class="gly">[</span>attr<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                try <span class="gly">{</span></code></li><li class="uncovered"><code>                    self.__data<span class="gly">[</span>attr<span class="gly">]</span> = JSON.<span class="func">parse</span>(self.__data<span class="gly">[</span>attr<span class="gly">]</span> + <span class="S">''</span>);</code></li><li class=""><code>                <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>                    console.<span class="func">log</span>(e.stack);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (type.name === <span class="S">'Array'</span> <span class="gly">|</span><span class="gly">|</span> <span class="kwrd">typeof</span> type === <span class="S">'object'</span> &amp;&amp; type.constructor.name === <span class="S">'Array'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                self.__data<span class="gly">[</span>attr<span class="gly">]</span> = <span class="kwrd">new</span> <span class="func">List</span>(self.__data<span class="gly">[</span>attr<span class="gly">]</span>, type, self);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">getDefault</span>(attr) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> def = properties<span class="gly">[</span>attr<span class="gly">]</span><span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span>;</code><span class="hits">126</span></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">isdef</span>(def)) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> def === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="func">def</span>();</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> def;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> null;</code><span class="hits">126</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    this.<span class="func">trigger</span>(<span class="S">"initialize"</span>);</code><span class="hits">26</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @param {String} prop - property name</span></code></li><li class=""><code><span class="C"> * @param {Object} params - various property configuration</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.defineProperty = <span class="kwrd">function</span> (prop, params) <span class="gly">{</span></code></li><li class="covered"><code>    this.schema.<span class="func">defineProperty</span>(this.modelName, prop, params);</code><span class="hits">9</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.whatTypeName = <span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ds = this.schema.definitions<span class="gly">[</span>this.modelName<span class="gly">]</span>;</code><span class="hits">87</span></li><li class="covered"><code>    <span class="kwrd">return</span> ds.properties<span class="gly">[</span>propName<span class="gly">]</span> &amp;&amp; ds.properties<span class="gly">[</span>propName<span class="gly">]</span>.type.name;</code><span class="hits">87</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.clone = <span class="kwrd">function</span> <span class="func">clone</span>(o) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> ret = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    Object.<span class="func">keys</span>(o).<span class="func">forEach</span>(<span class="kwrd">function</span> (val) <span class="gly">{</span></code></li><li class="uncovered"><code>        ret<span class="gly">[</span>val<span class="gly">]</span> = o<span class="gly">[</span>val<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> ret;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass._forDB = <span class="kwrd">function</span> (data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> res = <span class="gly">{</span><span class="gly">}</span>, NoSQL = <span class="gly">[</span><span class="S">'mongodb'</span>, <span class="S">'mongoose'</span>, <span class="S">'riak'</span>, <span class="S">'nano'</span><span class="gly">]</span>;</code><span class="hits">13</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (this.<span class="func">whatTypeName</span>(propName) === <span class="S">'JSON'</span> <span class="gly">|</span><span class="gly">|</span> data<span class="gly">[</span>propName<span class="gly">]</span> instanceof Array) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (NoSQL.<span class="func">indexOf</span>(this.schema.adapter.name) === -1) <span class="gly">{</span></code></li><li class="uncovered"><code>                res<span class="gly">[</span>propName<span class="gly">]</span> = JSON.<span class="func">stringify</span>(data<span class="gly">[</span>propName<span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                res<span class="gly">[</span>propName<span class="gly">]</span> = data<span class="gly">[</span>propName<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            res<span class="gly">[</span>propName<span class="gly">]</span> = data<span class="gly">[</span>propName<span class="gly">]</span>;</code><span class="hits">87</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">13</span></li><li class="covered"><code>    <span class="kwrd">return</span> res;</code><span class="hits">13</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.q = <span class="gly">{</span></code></li><li class=""><code>    conditions: <span class="gly">{</span><span class="gly">}</span>,</code></li><li class=""><code>    params: <span class="gly">{</span><span class="gly">}</span>,</code></li><li class=""><code>    pkey: false,</code></li><li class=""><code>    fields: false</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.whatTypeName = <span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.constructor.<span class="func">whatTypeName</span>(propName);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Create new instance of Model class, saved in database</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param data [optional]</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, obj)</span></code></li><li class=""><code><span class="C"> * callback called with arguments:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *   - err (null or Error)</span></code></li><li class=""><code><span class="C"> *   - instance (null or Model)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.create = <span class="kwrd">function</span> (data, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> modelName = this.modelName;</code><span class="hits">10</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> data === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        callback = data;</code><span class="hits">4</span></li><li class="covered"><code>        data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback !== <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class=""><code>        callback = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> obj = null;</code><span class="hits">10</span></li><li class=""><code>    <span class="C">// if we come from save</span></code></li><li class=""><code>    <span class="kwrd">if</span> (data instanceof this &amp;&amp; !data.id) <span class="gly">{</span></code></li><li class="covered"><code>        obj = data;</code><span class="hits">3</span></li><li class="covered"><code>        data = obj.<span class="func">toObject</span>(true);</code><span class="hits">3</span></li><li class="covered"><code>        obj.<span class="func">_initProperties</span>(data, false);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="func">create</span>();</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        obj = <span class="kwrd">new</span> <span class="func">this</span>(data);</code><span class="hits">7</span></li><li class="covered"><code>        data = obj.<span class="func">toObject</span>(true);</code><span class="hits">7</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// validation required</span></code></li><li class=""><code>        obj.<span class="func">isValid</span>(<span class="kwrd">function</span> (valid) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!valid) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Validation error'</span>), obj);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">create</span>();</code><span class="hits">7</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">7</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">create</span>() <span class="gly">{</span></code></li><li class=""><code>        obj.<span class="func">trigger</span>(<span class="S">'create'</span>, <span class="kwrd">function</span> (done) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">var</span> data = this.<span class="func">toObject</span>(true);  <span class="C">// Added this to fix the beforeCreate trigger not fire.</span></code></li><li class=""><code>            <span class="C">// The fix is per issue #72 and the fix was found by by5739.</span></code></li><li class=""><code></code></li><li class=""><code>            this.<span class="func">_adapter</span>().<span class="func">create</span>(modelName, this.constructor.<span class="func">_forDB</span>(data), <span class="kwrd">function</span> (err, id, rev) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="covered"><code>                    obj.__data.id = id;</code><span class="hits">9</span></li><li class="covered"><code>                    obj.__dataWas.id = id;</code><span class="hits">9</span></li><li class="covered"><code>                    <span class="func">defineReadonlyProp</span>(obj, <span class="S">'id'</span>, id);</code><span class="hits">9</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                <span class="kwrd">if</span> (rev) <span class="gly">{</span></code></li><li class="uncovered"><code>                    obj._rev = rev;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                done.<span class="func">call</span>(this, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>                        <span class="func">callback</span>(err, obj);</code><span class="hits">9</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">9</span></li><li class="covered"><code>            <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">9</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">stillConnecting</span>(schema, obj, args) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (schema.connected) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> false;</code><span class="hits">28</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> method = args.callee;</code></li><li class=""><code>    schema.<span class="func">on</span>(<span class="S">'connected'</span>, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        method.<span class="func">apply</span>(obj, <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(args));</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> true;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update or insert (create)</span></code></li><li class=""><code><span class="C"> * @param {Object} query - object.</span></code></li><li class=""><code><span class="C"> * @param {Object} data - object to find or create.</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.upsert = AbstractClass.updateOrCreate = <span class="kwrd">function</span> <span class="func">upsert</span>(query, data, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> data) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = data;</code></li><li class="uncovered"><code>        data = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> Model = this;</code></li><li class=""><code>    <span class="kwrd">if</span> (query.id) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (this.schema.adapter.updateOrCreate) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> inst = <span class="kwrd">new</span> <span class="func">Model</span>(query);</code></li><li class=""><code>            this.schema.adapter.<span class="func">updateOrCreate</span>(Model.modelName, inst.<span class="func">toObject</span>(), <span class="kwrd">function</span> (err, found) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> obj;</code></li><li class=""><code>                <span class="kwrd">if</span> (found) <span class="gly">{</span></code></li><li class="uncovered"><code>                    inst.<span class="func">_initProperties</span>(found);</code></li><li class="uncovered"><code>                    obj = inst;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    obj = null;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, obj);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            this.<span class="func">findById</span>(query.id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>                <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>                    inst.<span class="func">updateAttributes</span>(data, callback);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    data = helpers.<span class="func">merge</span>(data, query);</code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> obj = <span class="kwrd">new</span> <span class="func">Model</span>(data);</code></li><li class="uncovered"><code>                    obj.<span class="func">save</span>(data, callback);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        Model.<span class="func">findOne</span>(<span class="gly">{</span></code></li><li class=""><code>            where: query</code></li><li class=""><code>        <span class="gly">}</span>, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (err.message &amp;&amp; !/NotFound/gi.<span class="func">test</span>(err.message)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="func">callback</span>(err, inst);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>                inst.<span class="func">updateAttributes</span>(data, callback);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                data = helpers.<span class="func">merge</span>(data, query);</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> obj = <span class="kwrd">new</span> <span class="func">Model</span>(data);</code></li><li class="uncovered"><code>                obj.<span class="func">save</span>(data, callback);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find one record, same as `all`, limited by 1 and return object, not collection,</span></code></li><li class=""><code><span class="C"> * if not found, create using data provided as second argument</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} query - search conditions: {where: {test: 'me'}}.</span></code></li><li class=""><code><span class="C"> * @param {Object} data - object to create.</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.findOrCreate = <span class="kwrd">function</span> <span class="func">findOrCreate</span>(query, data, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments))</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> data) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = data;</code></li><li class="uncovered"><code>        data = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class=""><code>    this.<span class="func">findOne</span>(<span class="gly">{</span>where: query<span class="gly">}</span>, <span class="kwrd">function</span> (err, record) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (record) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(null, record);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        data = helpers.<span class="func">merge</span>(query, data);</code></li><li class="uncovered"><code>        self.<span class="func">create</span>(data, callback);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether object exitst in database</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {id} id - identifier of object (primary key value)</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callbacl called with (err, exists: Bool)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.exists = <span class="kwrd">function</span> <span class="func">exists</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments))</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = <span class="func">getInstanceId</span>(id);</code></li><li class="uncovered"><code>        this.schema.adapter.<span class="func">exists</span>(this.modelName, id, callback);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Model::exists requires positive id argument'</span>));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find instances of Model, matched by query</span></code></li><li class=""><code><span class="C"> * make sure you have marked as `index: true` fields for filter or sort</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params (optional)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - where: Object `{ key: val, key2: {gt: 'val2'}}`</span></code></li><li class=""><code><span class="C"> * - include: String, Object or Array. See AbstractClass.include documentation.</span></code></li><li class=""><code><span class="C"> * - order: String</span></code></li><li class=""><code><span class="C"> * - limit: Number</span></code></li><li class=""><code><span class="C"> * - skip: Number</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} callback (required) called with arguments:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - err (null or Error)</span></code></li><li class=""><code><span class="C"> * - Array of instances</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.find = <span class="kwrd">function</span> <span class="func">find</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> params) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">Query</span>(this.schema.models<span class="gly">[</span>this.modelName<span class="gly">]</span>, <span class="S">'find'</span>, params);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> null;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        params = <span class="func">buildQuery</span>(params, this);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> constr = this;</code></li><li class=""><code>        this.schema.adapter.<span class="func">all</span>(this.modelName, params, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (data &amp;&amp; data.map) <span class="gly">{</span></code></li><li class=""><code>                data.<span class="func">forEach</span>(<span class="kwrd">function</span> (d, i) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> obj = <span class="kwrd">new</span> constr;</code></li><li class="uncovered"><code>                    obj.<span class="func">_initProperties</span>(d, false);</code></li><li class="uncovered"><code>                    data<span class="gly">[</span>i<span class="gly">]</span> = obj;</code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class=""><code>                <span class="kwrd">if</span> (data &amp;&amp; data.countBeforeLimit) <span class="gly">{</span></code></li><li class="uncovered"><code>                    data<span class="gly">[</span><span class="S">'countBeforeLimit'</span><span class="gly">]</span> = data.countBeforeLimit;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, data);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find object by id</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {id} id - primary key value</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.findById = <span class="kwrd">function</span> <span class="func">findById</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments))</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class="uncovered"><code>    id = <span class="func">getInstanceId</span>(id);</code></li><li class=""><code>    this.schema.adapter.<span class="func">findById</span>(this.modelName, id, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> obj = null;</code></li><li class=""><code>        <span class="kwrd">if</span> (data) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!data.id) <span class="gly">{</span></code></li><li class="uncovered"><code>                data.id = id;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            obj = <span class="kwrd">new</span> <span class="func">this</span>();</code></li><li class="uncovered"><code>            obj.<span class="func">_initProperties</span>(data, false);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err, obj);</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find all instances of Model, matched by query</span></code></li><li class=""><code><span class="C"> * make sure you have marked as `index: true` fields for filter or sort</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params (optional)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - where: Object `{ key: val, key2: {gt: 'val2'}}`</span></code></li><li class=""><code><span class="C"> * - include: String, Object or Array. See AbstractClass.include documentation.</span></code></li><li class=""><code><span class="C"> * - order: String</span></code></li><li class=""><code><span class="C"> * - limit: Number</span></code></li><li class=""><code><span class="C"> * - skip: Number</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} callback (required) called with arguments:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - err (null or Error)</span></code></li><li class=""><code><span class="C"> * - Array of instances</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.exec = AbstractClass.run = AbstractClass.all = <span class="kwrd">function</span> <span class="func">all</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> params) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">Query</span>(this.schema.models<span class="gly">[</span>this.modelName<span class="gly">]</span>, <span class="S">'all'</span>, params);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        params = <span class="func">buildQuery</span>(params, this);</code><span class="hits">8</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> constr = this;</code><span class="hits">8</span></li><li class=""><code>        this.schema.adapter.<span class="func">all</span>(this.modelName, params, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span> (data &amp;&amp; data.map) <span class="gly">{</span></code></li><li class=""><code>                data.<span class="func">forEach</span>(<span class="kwrd">function</span> (d, i) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">var</span> obj = <span class="kwrd">new</span> constr;</code><span class="hits">4</span></li><li class="covered"><code>                    obj.<span class="func">_initProperties</span>(d, false);</code><span class="hits">4</span></li><li class="covered"><code>                    data<span class="gly">[</span>i<span class="gly">]</span> = obj;</code><span class="hits">4</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code>                <span class="kwrd">if</span> (data &amp;&amp; data.countBeforeLimit) <span class="gly">{</span></code></li><li class="uncovered"><code>                    data<span class="gly">[</span><span class="S">'countBeforeLimit'</span><span class="gly">]</span> = data.countBeforeLimit;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                <span class="func">callback</span>(err, data);</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find one record, same as `all`, limited by 1 and return object, not collection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params - search conditions: {where: {test: 'me'}}</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.findOne = <span class="kwrd">function</span> <span class="func">findOne</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> params) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">Query</span>(this.schema.models<span class="gly">[</span>this.modelName<span class="gly">]</span>, <span class="S">'findOne'</span>, params);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> null;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            this.q.params.limit = 1;</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                callback = params;</code></li><li class="uncovered"><code>                params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            params = <span class="func">buildQuery</span>(params, this);</code></li><li class="uncovered"><code>            params.limit = 1;</code></li><li class=""><code>            this.<span class="func">all</span>(params, <span class="kwrd">function</span> (err, collection) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (err <span class="gly">|</span><span class="gly">|</span> !collection <span class="gly">|</span><span class="gly">|</span> !collection.length &gt; 0) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="func">callback</span>(err, null);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, collection<span class="gly">[</span>0<span class="gly">]</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">substractDirtyAttributes</span>(object, data) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(object.<span class="func">toObject</span>()).<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (data.<span class="func">hasOwnProperty</span>(attr) &amp;&amp; object.<span class="func">propertyChanged</span>(attr)) <span class="gly">{</span></code></li><li class="uncovered"><code>            delete data<span class="gly">[</span>attr<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Destroy all records</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.schema.adapter.<span class="func">destroyAll</span>(this.modelName, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return count of matched records</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params - search conditions (optional)</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback, called with (err, count)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.count = <span class="kwrd">function</span> (params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = null;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    params = <span class="func">buildQuery</span>(params, this);</code></li><li class="uncovered"><code>    this.schema.adapter.<span class="func">count</span>(this.modelName, callback, params);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Allows you to load relations of several objects and optimize numbers of requests.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Array} objects - array of instances</span></code></li><li class=""><code><span class="C"> * @param {String|Object|Array} include - which relations you want to load.</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - Callback called when relations are loaded</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Examples:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - User.include(users, 'posts', function() {}); will load all users posts with only one additional request.</span></code></li><li class=""><code><span class="C"> * - User.include(users, ['posts'], function() {}); ~~~C4~~~</span></code></li><li class=""><code><span class="C"> * - User.include(users, ['posts', 'passports'], function() {}); ~~~C5~~~</span></code></li><li class=""><code><span class="C"> *     additional requests.</span></code></li><li class=""><code><span class="C"> * - Passport.include(passports, {owner: 'posts'}, function() {}); ~~~C6~~~</span></code></li><li class=""><code><span class="C"> *     posts of each owner loaded</span></code></li><li class=""><code><span class="C"> * - Passport.include(passports, {owner: ['posts', 'passports']}); ~~~C7~~~</span></code></li><li class=""><code><span class="C"> * - Passport.include(passports, {owner: [{posts: 'images'}, 'passports']}); ~~~C8~~~</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.include = <span class="kwrd">function</span> (objects, include, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (</code></li><li class=""><code>        (include.constructor.name === <span class="S">'Array'</span> &amp;&amp; include.length === 0) <span class="gly">|</span><span class="gly">|</span></code></li><li class=""><code>        (include.constructor.name === <span class="S">'Object'</span> &amp;&amp; Object.<span class="func">keys</span>(include).length === 0)</code></li><li class=""><code>        ) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(null, objects);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    include = processIncludeJo<span class="kwrd">in</span>(include);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> keyVals = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> objsByKeys = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> nbCallbacks = 0;</code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i &lt; include.length; i++) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> cb = <span class="func">processIncludeItem</span>(objects, include<span class="gly">[</span>i<span class="gly">]</span>, keyVals, objsByKeys);</code></li><li class=""><code>        <span class="kwrd">if</span> (cb !== null) <span class="gly">{</span></code></li><li class="uncovered"><code>            nbCallbacks++;</code></li><li class=""><code>            <span class="func">cb</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (--nbCallbacks === 0) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">callback</span>(null, objects);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>(null, objects);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> processIncludeJo<span class="kwrd">in</span>(ij) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> ij === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            ij = <span class="gly">[</span>ij<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (ij.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> newIj = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> ij) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> obj = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>                obj<span class="gly">[</span>key<span class="gly">]</span> = ij<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class="uncovered"><code>                newIj.<span class="func">push</span>(obj);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> newIj;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> ij;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">processIncludeItem</span>(objs, include, keyVals, objsByKeys) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> relations = self.relations, relationName, subInclude;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (include.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            relationName = Object.<span class="func">keys</span>(include)<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class="uncovered"><code>            subInclude = include<span class="gly">[</span>relationName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            relationName = include;</code></li><li class="uncovered"><code>            subInclude = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> relation = relations<span class="gly">[</span>relationName<span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">var</span> req = <span class="gly">{</span></code></li><li class=""><code>            <span class="S">'where'</span>: <span class="gly">{</span><span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> j = 0; j &lt; objs.length; j++) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>objs<span class="gly">[</span>j<span class="gly">]</span><span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>objs<span class="gly">[</span>j<span class="gly">]</span><span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">]</span> = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>objs<span class="gly">[</span>j<span class="gly">]</span><span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">]</span>.<span class="func">push</span>(objs<span class="gly">[</span>j<span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span> = Object.<span class="func">keys</span>(objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span>.length &gt; 0) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// deep clone is necessary since inq seems to change the processed array</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> keysToBeProcessed = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> inValues = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> f = 0; f &lt; keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span>.length; f++) <span class="gly">{</span></code></li><li class="uncovered"><code>                keysToBeProcessed<span class="gly">[</span>keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>f<span class="gly">]</span><span class="gly">]</span> = true;</code></li><li class=""><code>                <span class="kwrd">if</span> (keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>f<span class="gly">]</span> !== <span class="S">'null'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    inValues.<span class="func">push</span>(keyVals<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>f<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            req<span class="gly">[</span><span class="S">'where'</span><span class="gly">]</span><span class="gly">[</span>relation.keyTo<span class="gly">]</span> = <span class="gly">{</span></code></li><li class=""><code>                inq: inValues</code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class="uncovered"><code>            req<span class="gly">[</span><span class="S">'include'</span><span class="gly">]</span> = subInclude;</code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">return</span> <span class="kwrd">function</span> (clbk) <span class="gly">{</span></code></li><li class=""><code>                relation.modelTo.<span class="func">all</span>(req, <span class="kwrd">function</span> (err, objsIncluded) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i &lt; objsIncluded.length; i++) <span class="gly">{</span></code></li><li class="uncovered"><code>                        delete keysToBeProcessed<span class="gly">[</span>objsIncluded<span class="gly">[</span>i<span class="gly">]</span><span class="gly">[</span>relation.keyTo<span class="gly">]</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>                        <span class="kwrd">var</span> objectsFrom = objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>objsIncluded<span class="gly">[</span>i<span class="gly">]</span><span class="gly">[</span>relation.keyTo<span class="gly">]</span><span class="gly">]</span>;</code></li><li class=""><code>                        <span class="kwrd">for</span> (<span class="kwrd">var</span> j = 0; j &lt; objectsFrom.length; j++) <span class="gly">{</span></code></li><li class=""><code>                            <span class="kwrd">if</span> (!objectsFrom<span class="gly">[</span>j<span class="gly">]</span>.__cachedRelations) <span class="gly">{</span></code></li><li class="uncovered"><code>                                objectsFrom<span class="gly">[</span>j<span class="gly">]</span>.__cachedRelations = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>                            <span class="gly">}</span></code></li><li class=""><code>                            <span class="kwrd">if</span> (relation.multiple) <span class="gly">{</span></code></li><li class=""><code>                                <span class="kwrd">if</span> (!objectsFrom<span class="gly">[</span>j<span class="gly">]</span>.__cachedRelations<span class="gly">[</span>relationName<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                                    objectsFrom<span class="gly">[</span>j<span class="gly">]</span>.__cachedRelations<span class="gly">[</span>relationName<span class="gly">]</span> = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>                                <span class="gly">}</span></code></li><li class="uncovered"><code>                                objectsFrom<span class="gly">[</span>j<span class="gly">]</span>.__cachedRelations<span class="gly">[</span>relationName<span class="gly">]</span>.<span class="func">push</span>(objsIncluded<span class="gly">[</span>i<span class="gly">]</span>);</code></li><li class=""><code>                            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                                objectsFrom<span class="gly">[</span>j<span class="gly">]</span>.__cachedRelations<span class="gly">[</span>relationName<span class="gly">]</span> = objsIncluded<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class=""><code>                            <span class="gly">}</span></code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                    <span class="C">// No relation have been found for these keys</span></code></li><li class=""><code>                    <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> keysToBeProcessed) <span class="gly">{</span></code></li><li class="uncovered"><code>                        <span class="kwrd">var</span> objectsFromRelation = objsByKeys<span class="gly">[</span>relation.keyFrom<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class=""><code>                        <span class="kwrd">for</span> (<span class="kwrd">var</span> n = 0; n &lt; objectsFromRelation.length; n++) <span class="gly">{</span></code></li><li class=""><code>                            <span class="kwrd">if</span> (!objectsFromRelation<span class="gly">[</span>n<span class="gly">]</span>.__cachedRelations) <span class="gly">{</span></code></li><li class="uncovered"><code>                                objectsFromRelation<span class="gly">[</span>n<span class="gly">]</span>.__cachedRelations = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>                            <span class="gly">}</span></code></li><li class="uncovered"><code>                            objectsFromRelation<span class="gly">[</span>n<span class="gly">]</span>.__cachedRelations<span class="gly">[</span>relationName<span class="gly">]</span> = relation.multiple ? <span class="gly">[</span><span class="gly">]</span> : null;</code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="func">clbk</span>(err, objsIncluded);</code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> null;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return string representation of class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @override default toString method</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.toString = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'[Model '</span> + this.modelName + <span class="S">']'</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Save instance. When instance haven't id, create method called instead.</span></code></li><li class=""><code><span class="C"> * Triggers: validate, save, update | create</span></code></li><li class=""><code><span class="C"> * @param {Object} options {validate: true, throws: false} [optional]</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - (err, obj)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.save = <span class="kwrd">function</span> (options, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> options === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        callback = options;</code><span class="hits">4</span></li><li class="covered"><code>        options = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    callback = callback <span class="gly">|</span><span class="gly">|</span> <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">4</span></li><li class="covered"><code>    options = options <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!(<span class="S">'validate'</span> <span class="kwrd">in</span> options)) <span class="gly">{</span></code></li><li class="covered"><code>        options.validate = true;</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!(<span class="S">'throws'</span> <span class="kwrd">in</span> options)) <span class="gly">{</span></code></li><li class="covered"><code>        options<span class="gly">[</span><span class="S">'throws'</span><span class="gly">]</span> = false;</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (options.validate) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">isValid</span>(<span class="kwrd">function</span> (valid) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (valid) <span class="gly">{</span></code></li><li class="covered"><code>                save.<span class="func">call</span>(this);</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> err = <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Validation error'</span>);</code></li><li class=""><code>                <span class="C">// throws option is dangerous for async usage</span></code></li><li class=""><code>                <span class="kwrd">if</span> (options<span class="gly">[</span><span class="S">'throws'</span><span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    throw err;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, this);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        save.<span class="func">call</span>(this);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">save</span>() <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">trigger</span>(<span class="S">'save'</span>, <span class="kwrd">function</span> (saveDone) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> modelName = this.constructor.modelName;</code><span class="hits">4</span></li><li class="covered"><code>            <span class="kwrd">var</span> data = this.<span class="func">toObject</span>(true);</code><span class="hits">4</span></li><li class="covered"><code>            <span class="kwrd">var</span> inst = this;</code><span class="hits">4</span></li><li class=""><code>            <span class="kwrd">if</span> (inst.id) <span class="gly">{</span></code></li><li class=""><code>                inst.<span class="func">trigger</span>(<span class="S">'update'</span>, <span class="kwrd">function</span> (updateDone) <span class="gly">{</span></code></li><li class=""><code>                    inst.<span class="func">_adapter</span>().<span class="func">save</span>(modelName, inst.constructor.<span class="func">_forDB</span>(data), <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                            console.<span class="func">log</span>(err);</code></li><li class=""><code>                        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                            inst.<span class="func">_initProperties</span>(data, false);</code><span class="hits">1</span></li><li class=""><code>                        <span class="gly">}</span></code></li><li class=""><code>                        updateDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                            saveDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                                <span class="func">callback</span>(err, inst);</code><span class="hits">1</span></li><li class="covered"><code>                            <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>                    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>                <span class="gly">}</span>, data);</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                inst.constructor.<span class="func">create</span>(inst, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                    saveDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                        <span class="func">callback</span>(err, inst);</code><span class="hits">3</span></li><li class="covered"><code>                    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.isNewRecord = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> !this.id;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return adapter of current record</span></code></li><li class=""><code><span class="C"> * @private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>._adapter = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.constructor.schema.adapter;</code><span class="hits">14</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Convert instance to Object</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Boolean} onlySchema - restrict properties to schema only, default false</span></code></li><li class=""><code><span class="C"> * when onlySchema == true, only properties defined in schema returned,</span></code></li><li class=""><code><span class="C"> * otherwise all enumerable properties returned</span></code></li><li class=""><code><span class="C"> * @returns {Object} - canonical object representation (no getters and setters)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.toObject = <span class="kwrd">function</span> (onlySchema) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">23</span></li><li class="covered"><code>    <span class="kwrd">var</span> ds = this.constructor.schema.definitions<span class="gly">[</span>this.constructor.modelName<span class="gly">]</span>;</code><span class="hits">23</span></li><li class="covered"><code>    <span class="kwrd">var</span> properties = ds.properties;</code><span class="hits">23</span></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">23</span></li><li class=""><code></code></li><li class=""><code>    this.constructor.<span class="func">forEachProperty</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (self<span class="gly">[</span>attr<span class="gly">]</span> instanceof List) <span class="gly">{</span></code></li><li class="uncovered"><code>            data<span class="gly">[</span>attr<span class="gly">]</span> = self<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">toObject</span>();</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (self.__data.<span class="func">hasOwnProperty</span>(attr)) <span class="gly">{</span></code></li><li class="covered"><code>            data<span class="gly">[</span>attr<span class="gly">]</span> = self<span class="gly">[</span>attr<span class="gly">]</span>;</code><span class="hits">198</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            data<span class="gly">[</span>attr<span class="gly">]</span> = null;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">23</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!onlySchema) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(self).<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!data.<span class="func">hasOwnProperty</span>(attr)) <span class="gly">{</span></code></li><li class="uncovered"><code>                data<span class="gly">[</span>attr<span class="gly">]</span> = this<span class="gly">[</span>attr<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> data;</code><span class="hits">23</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// AbstractClass.prototype.hasOwnProperty = function (prop) {</span></code></li><li class=""><code><span class="C">//     return this.__data &amp;&amp; this.__data.hasOwnProperty(prop) ||</span></code></li><li class=""><code><span class="C">//         Object.getOwnPropertyNames(this).indexOf(prop) !== -1;</span></code></li><li class=""><code><span class="C">// };</span></code></li><li class=""><code></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.toJSON = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.<span class="func">toObject</span>();</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Delete object from persistence</span></code></li><li class=""><code><span class="C"> * @param {Function} callback called with (error)</span></code></li><li class=""><code><span class="C"> * @triggers `destroy` hook (async) before and after destroying object</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.destroy = <span class="kwrd">function</span> (callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">trigger</span>(<span class="S">'destroy'</span>, <span class="kwrd">function</span> (destroyed) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">_adapter</span>().<span class="func">destroy</span>(this.constructor.modelName, this.id, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>            <span class="func">destroyed</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (callback)</code></li><li class="uncovered"><code>                    <span class="func">callback</span>(err);</code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Destroy records</span></code></li><li class=""><code><span class="C"> * @param {Object|String|Number} id - remove conditions</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.destroyById = <span class="kwrd">function</span> <span class="func">destroyById</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    id = <span class="func">getInstanceId</span>(id);</code></li><li class=""><code>    this.<span class="func">findById</span>(id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            inst.<span class="func">destroy</span>(callback);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Destroy records</span></code></li><li class=""><code><span class="C"> * @param {Object} params - remove conditions</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.remove = <span class="kwrd">function</span> <span class="func">remove</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">Query</span>(this.schema.models<span class="gly">[</span>this.modelName<span class="gly">]</span>, <span class="S">'remove'</span>, params);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        this.schema.adapter.<span class="func">remove</span>(this.modelName, params, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// clearCache(this);</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update single attribute</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * equals to `updateAttributes({name: value}, cb)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name - name of property</span></code></li><li class=""><code><span class="C"> * @param {Mixed} value - value of property</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.updateAttribute = <span class="kwrd">function</span> <span class="func">updateAttribute</span>(name, value, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    data<span class="gly">[</span>name<span class="gly">]</span> = value;</code><span class="hits">1</span></li><li class="covered"><code>    this.<span class="func">updateAttributes</span>(data, callback);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update set of attributes</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * this method performs validation before updating</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @trigger `validation`, `save` and `update` hooks</span></code></li><li class=""><code><span class="C"> * @param {Object} data - data to update</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttributes</span>(data, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> inst = this;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> model = this.constructor.modelName;</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!data)</code></li><li class="covered"><code>        data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// update instance's properties</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        inst<span class="gly">[</span>key<span class="gly">]</span> = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    inst.<span class="func">isValid</span>(<span class="kwrd">function</span> (valid) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!valid) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Validation error'</span>), inst);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">update</span>();</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">update</span>() <span class="gly">{</span></code></li><li class=""><code>        inst.<span class="func">trigger</span>(<span class="S">'save'</span>, <span class="kwrd">function</span> (saveDone) <span class="gly">{</span></code></li><li class=""><code>            inst.<span class="func">trigger</span>(<span class="S">'update'</span>, <span class="kwrd">function</span> (done) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>                Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>                    data<span class="gly">[</span>key<span class="gly">]</span> = inst<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">3</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>                inst.<span class="func">_adapter</span>().<span class="func">updateAttributes</span>(model, inst.id, inst.constructor.<span class="func">_forDB</span>(data), <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (!err) <span class="gly">{</span></code></li><li class=""><code>                        <span class="C">// update _was attrs</span></code></li><li class=""><code>                        Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>                            inst.__dataWas<span class="gly">[</span>key<span class="gly">]</span> = inst.__data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">3</span></li><li class="covered"><code>                        <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                    done.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                        saveDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                            <span class="func">callback</span>(err, inst);</code><span class="hits">2</span></li><li class="covered"><code>                        <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>                    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>            <span class="gly">}</span>, data);</code><span class="hits">4</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update records</span></code></li><li class=""><code><span class="C"> * @param {Object} filter - update conditions</span></code></li><li class=""><code><span class="C"> * @param {Object} data - data to update</span></code></li><li class=""><code><span class="C"> * @param {Object} options - data to update</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.update = <span class="kwrd">function</span> <span class="func">update</span>(filter, data, options, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span>(this.schema.adapter.update) <span class="gly">{</span></code></li><li class=""><code>        this.schema.adapter.<span class="func">update</span>(this.modelName, filter, data, options, <span class="kwrd">function</span> (err, affected) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>(err, affected);</code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'Method update undefined for this adapter'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.fromObject = <span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(obj).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="uncovered"><code>        this<span class="gly">[</span>key<span class="gly">]</span> = obj<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Checks is property changed based on current property and initial value</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} attr - property name</span></code></li><li class=""><code><span class="C"> * @return Boolean</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.propertyChanged = <span class="kwrd">function</span> <span class="func">propertyChanged</span>(attr) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.__data<span class="gly">[</span>attr<span class="gly">]</span> !== this.__dataWas<span class="gly">[</span>attr<span class="gly">]</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Reload object from persistence</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @requires `id` member of `object` to be able to call `find`</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - called with (err, instance) arguments</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.reload = <span class="kwrd">function</span> <span class="func">reload</span>(callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    this.constructor.<span class="func">findById</span>(this.id, callback);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Reset dirty attributes</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * this method does not perform any database operation it just reset object to it's</span></code></li><li class=""><code><span class="C"> * initial state</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.reset = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> obj = this;</code></li><li class=""><code>    Object.<span class="func">keys</span>(obj).<span class="func">forEach</span>(<span class="kwrd">function</span> (k) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (k !== <span class="S">'id'</span> &amp;&amp; !obj.constructor.schema.definitions<span class="gly">[</span>obj.constructor.modelName<span class="gly">]</span>.properties<span class="gly">[</span>k<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            delete obj<span class="gly">[</span>k<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (obj.<span class="func">propertyChanged</span>(k)) <span class="gly">{</span></code></li><li class="uncovered"><code>            obj<span class="gly">[</span>k<span class="gly">]</span> = obj<span class="gly">[</span>k + <span class="S">'_was'</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Declare hasMany relation</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Class} anotherClass - class to has many</span></code></li><li class=""><code><span class="C"> * @param {Object} params - configuration {as:, foreignKey:}</span></code></li><li class=""><code><span class="C"> * @example `User.hasMany(Post, {as: 'posts', foreignKey: 'authorId'});`</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.hasMany = <span class="kwrd">function</span> <span class="func">hasMany</span>(anotherClass, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> methodName = params.as <span class="gly">|</span><span class="gly">|</span> <span class="func">pluralize</span>(anotherClass.modelName);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> fk = params.foreignKey;</code></li><li class=""><code></code></li><li class=""><code>    this.relations<span class="gly">[</span>methodName<span class="gly">]</span> = <span class="gly">{</span></code></li><li class=""><code>        type: <span class="S">'hasMany'</span>,</code></li><li class=""><code>        keyFrom: <span class="S">'id'</span>,</code></li><li class=""><code>        keyTo: fk,</code></li><li class=""><code>        modelTo: anotherClass,</code></li><li class=""><code>        multiple: true</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// each instance of this class should have method named</span></code></li><li class=""><code>    <span class="C">// which is actually just anotherClass.all({where: {thisModelNameId: this.id}}, cb);</span></code></li><li class=""><code>    <span class="func">defineScope</span>(this.<span class="kwrd">prototype</span>, anotherClass, methodName, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> x = <span class="gly">{</span><span class="gly">}</span>, id;</code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.id === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            id = this.id.<span class="func">toString</span>();</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            id = this.id;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        x<span class="gly">[</span>fk<span class="gly">]</span> = id;</code></li><li class=""><code>        <span class="kwrd">return</span> <span class="gly">{</span></code></li><li class=""><code>            where: x</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span>, <span class="gly">{</span></code></li><li class=""><code>        find: find,</code></li><li class=""><code>        destroy: destroy</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// obviously, anotherClass should have attribute called `fk`</span></code></li><li class="uncovered"><code>    anotherClass.schema.<span class="func">defineForeignKey</span>(anotherClass.modelName, fk);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">find</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>        anotherClass.<span class="func">findById</span>(id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>            <span class="kwrd">if</span> (!inst)</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Not found'</span>));</code></li><li class=""><code>            <span class="kwrd">if</span> (inst<span class="gly">[</span>fk<span class="gly">]</span> === this.id) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(null, inst);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Permission denied'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">destroy</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">findById</span>(id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>            <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>                inst.<span class="func">destroy</span>(callback);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Not found'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Declare belongsTo relation</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Class} anotherClass - class to belong</span></code></li><li class=""><code><span class="C"> * @param {Object} params - configuration {as: 'propertyName', foreignKey: 'keyName'}</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * **Usage examples**</span></code></li><li class=""><code><span class="C"> * Suppose model Post have a *belongsTo* relationship with User (the author of the post). You could declare it this way:</span></code></li><li class=""><code><span class="C"> * Post.belongsTo(User, {as: 'author', foreignKey: 'userId'});</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * When a post is loaded, you can load the related author with:</span></code></li><li class=""><code><span class="C"> * post.author(function(err, user) {</span></code></li><li class=""><code><span class="C"> *     ~~~C22~~~</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * The related object is cached, so if later you try to get again the author, no additional request will be made.</span></code></li><li class=""><code><span class="C"> * But there is an optional boolean parameter in first position that set whether or not you want to reload the cache:</span></code></li><li class=""><code><span class="C"> * post.author(true, function(err, user) {</span></code></li><li class=""><code><span class="C"> *     ~~~C23~~~</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This optional parameter default value is false, so the related object will be loaded from cache if available.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.belongsTo = <span class="kwrd">function</span> (anotherClass, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> methodName = params.as;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> fk = params.foreignKey;</code></li><li class=""><code></code></li><li class=""><code>    this.relations<span class="gly">[</span>params<span class="gly">[</span><span class="S">'as'</span><span class="gly">]</span><span class="gly">]</span> = <span class="gly">{</span></code></li><li class=""><code>        type: <span class="S">'belongsTo'</span>,</code></li><li class=""><code>        keyFrom: params<span class="gly">[</span><span class="S">'foreignKey'</span><span class="gly">]</span>,</code></li><li class=""><code>        keyTo: <span class="S">'id'</span>,</code></li><li class=""><code>        modelTo: anotherClass,</code></li><li class=""><code>        multiple: false</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>    this.schema.<span class="func">defineForeignKey</span>(this.modelName, fk);</code></li><li class="uncovered"><code>    this.<span class="kwrd">prototype</span><span class="gly">[</span><span class="S">'__finders__'</span><span class="gly">]</span> = this.<span class="kwrd">prototype</span><span class="gly">[</span><span class="S">'__finders__'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="kwrd">prototype</span><span class="gly">[</span><span class="S">'__finders__'</span><span class="gly">]</span><span class="gly">[</span>methodName<span class="gly">]</span> = <span class="kwrd">function</span> (id, cb) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (id === null) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">cb</span>(null, null);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        anotherClass.<span class="func">findById</span>(id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class=""><code>            <span class="kwrd">if</span> (!inst)</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="func">cb</span>(null, null);</code></li><li class=""><code>            <span class="kwrd">if</span> (inst.id === this<span class="gly">[</span>fk<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(null, inst);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Permission denied'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="kwrd">prototype</span><span class="gly">[</span>methodName<span class="gly">]</span> = <span class="kwrd">function</span> (refresh, p) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>            p = refresh;</code></li><li class="uncovered"><code>            refresh = false;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (arguments.length &gt; 2) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Method can\'t be called with more than two arguments'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> cachedValue;</code></li><li class=""><code>        <span class="kwrd">if</span> (!refresh &amp;&amp; this.__cachedRelations &amp;&amp; (<span class="kwrd">typeof</span> this.__cachedRelations<span class="gly">[</span>methodName<span class="gly">]</span> !== <span class="S">'undefined'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            cachedValue = this.__cachedRelations<span class="gly">[</span>methodName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (p instanceof AbstractClass) <span class="gly">{</span> <span class="C">// acts as setter</span></code></li><li class="uncovered"><code>            this<span class="gly">[</span>fk<span class="gly">]</span> = p.id;</code></li><li class="uncovered"><code>            this.__cachedRelations<span class="gly">[</span>methodName<span class="gly">]</span> = p;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> p === <span class="S">'function'</span>) <span class="gly">{</span> <span class="C">// acts as async getter</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> cachedValue === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>                this.__finders__<span class="gly">[</span>methodName<span class="gly">]</span>.<span class="func">apply</span>(self, <span class="gly">[</span>this<span class="gly">[</span>fk<span class="gly">]</span>, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (!err) <span class="gly">{</span></code></li><li class="uncovered"><code>                        self.__cachedRelations<span class="gly">[</span>methodName<span class="gly">]</span> = inst;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="func">p</span>(err, inst);</code></li><li class="uncovered"><code>                <span class="gly">}</span><span class="gly">]</span>);</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> this<span class="gly">[</span>fk<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">p</span>(null, cachedValue);</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> cachedValue;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> p === <span class="S">'undefined'</span>) <span class="gly">{</span> <span class="C">// acts as sync getter</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this<span class="gly">[</span>fk<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span> <span class="C">// setter</span></code></li><li class="uncovered"><code>            this<span class="gly">[</span>fk<span class="gly">]</span> = p;</code></li><li class="uncovered"><code>            delete this.__cachedRelations<span class="gly">[</span>methodName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define scope</span></code></li><li class=""><code><span class="C"> * TODO: describe behavior and usage examples</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name - scope name</span></code></li><li class=""><code><span class="C"> * @param {Object} params - scope condition</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.scope = <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="func">defineScope</span>(this, this, name, params);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">defineScope</span>(cls, targetClass, name, params, methods) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// collect meta info about scope</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!cls._scopeMeta) <span class="gly">{</span></code></li><li class="uncovered"><code>        cls._scopeMeta = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// only makes sence to add scope in meta if base and target classes</span></code></li><li class=""><code>    <span class="C">// are same</span></code></li><li class=""><code>    <span class="kwrd">if</span> (cls === targetClass) <span class="gly">{</span></code></li><li class="uncovered"><code>        cls._scopeMeta<span class="gly">[</span>name<span class="gly">]</span> = params;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!targetClass._scopeMeta) <span class="gly">{</span></code></li><li class="uncovered"><code>            targetClass._scopeMeta = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(cls, name, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> f = <span class="kwrd">function</span> <span class="func">caller</span>(condOrRefresh, cb) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> actualCond = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> actualRefresh = false;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> saveOnCache = true;</code></li><li class=""><code>                <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>                    cb = condOrRefresh;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="kwrd">if</span> (arguments.length === 2) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> condOrRefresh === <span class="S">'boolean'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                        actualRefresh = condOrRefresh;</code></li><li class=""><code>                    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                        actualCond = condOrRefresh;</code></li><li class="uncovered"><code>                        actualRefresh = true;</code></li><li class="uncovered"><code>                        saveOnCache = false;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Method can be only called with one or two arguments'</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (!this.__cachedRelations <span class="gly">|</span><span class="gly">|</span> (<span class="kwrd">typeof</span> this.__cachedRelations<span class="gly">[</span>name<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">|</span><span class="gly">|</span> actualRefresh) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> self = this;</code></li><li class=""><code>                    <span class="kwrd">return</span> targetClass.<span class="func">all</span>(<span class="func">mergeParams</span>(actualCond, caller._scope), <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (!err &amp;&amp; saveOnCache) <span class="gly">{</span></code></li><li class="uncovered"><code>                            self.__cachedRelations<span class="gly">[</span>name<span class="gly">]</span> = data;</code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class="uncovered"><code>                        <span class="func">cb</span>(err, data);</code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">cb</span>(null, this.__cachedRelations<span class="gly">[</span>name<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>            f._scope = <span class="kwrd">typeof</span> params === <span class="S">'function'</span> ? params.<span class="func">call</span>(this) : params;</code></li><li class="uncovered"><code>            f.build = build;</code></li><li class="uncovered"><code>            f.create = create;</code></li><li class="uncovered"><code>            f.destroy = destroy;</code></li><li class="uncovered"><code>            f.destroyAll = destroyAll;</code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> methods) <span class="gly">{</span></code></li><li class="uncovered"><code>                f<span class="gly">[</span>i<span class="gly">]</span> = methods<span class="gly">[</span>i<span class="gly">]</span>.<span class="func">bind</span>(this);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// define sub-scopes</span></code></li><li class=""><code>            Object.<span class="func">keys</span>(targetClass._scopeMeta).<span class="func">forEach</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>                Object.<span class="func">defineProperty</span>(f, name, <span class="gly">{</span></code></li><li class=""><code>                    enumerable: false,</code></li><li class=""><code>                    get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>                        <span class="func">mergeParams</span>(f._scope, targetClass._scopeMeta<span class="gly">[</span>name<span class="gly">]</span>);</code></li><li class="uncovered"><code>                        <span class="kwrd">return</span> f;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> f;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// and it should have create/build methods with binded thisModelNameId param</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">build</span>(data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">targetClass</span>(<span class="func">mergeParams</span>(this._scope, <span class="gly">{</span></code></li><li class=""><code>            where: data <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>).where);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">create</span>(data, cb) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> data === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            cb = data;</code></li><li class="uncovered"><code>            data = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        this.<span class="func">build</span>(data).<span class="func">save</span>(cb);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">destroy</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (callback)</code></li><li class="uncovered"><code>            <span class="func">callback</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/*</span></code></li><li class=""><code><span class="C">     Callback</span></code></li><li class=""><code><span class="C">     - The callback will be called after all elements are destroyed</span></code></li><li class=""><code><span class="C">     - For every destroy call which results in an error</span></code></li><li class=""><code><span class="C">     - If fetching the Elements on which destroyAll is called results in an error</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">destroyAll</span>(callback) <span class="gly">{</span></code></li><li class=""><code>        targetClass.<span class="func">all</span>(this._scope, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                (<span class="kwrd">function</span> <span class="func">loopOfDestruction</span>(data) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (data.length &gt; 0) <span class="gly">{</span></code></li><li class=""><code>                        data.<span class="func">shift</span>().<span class="func">destroy</span>(<span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                            <span class="kwrd">if</span> (err &amp;&amp; callback)</code></li><li class="uncovered"><code>                                <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>                            <span class="func">loopOfDestruction</span>(data);</code></li><li class="uncovered"><code>                        <span class="gly">}</span>);</code></li><li class=""><code>                    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (callback)</code></li><li class="uncovered"><code>                            <span class="func">callback</span>();</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="gly">}</span>(data));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">mergeParams</span>(base, update) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (update.where) <span class="gly">{</span></code></li><li class="uncovered"><code>            base.where = helpers.<span class="func">merge</span>(base.where, update.where);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// overwrite order</span></code></li><li class=""><code>        <span class="kwrd">if</span> (update.order) <span class="gly">{</span></code></li><li class="uncovered"><code>            base.order = update.order;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> base;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>AbstractClass.<span class="kwrd">prototype</span>.inspect = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> util.<span class="func">inspect</span>(this.__data, false, 4, true);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Create index in collection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String|Object} fields - index name</span></code></li><li class=""><code><span class="C"> * @param {Object} params - indexed fields list { name : 1, created : -1 }</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callbacl called with (err, exists: Bool)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.ensureIndex = <span class="kwrd">function</span> <span class="func">ensureIndex</span>(fields, params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>        callback = <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> err;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.schema.adapter.ensureIndex === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Model::ensureIndex not defined for this adapter'</span>));</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            this.schema.adapter.<span class="func">ensureIndex</span>(this.modelName, fields, params, callback);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Model::ensureIndex requires params argument'</span>));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">buildQuery</span>(opts, model) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> okey <span class="kwrd">in</span> model.q.conditions) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> opts.where === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            opts.where = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        opts.where<span class="gly">[</span>okey<span class="gly">]</span> = model.q.conditions<span class="gly">[</span>okey<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    model.q.conditions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> pkey <span class="kwrd">in</span> model.q.params) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> opts<span class="gly">[</span>pkey<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            opts<span class="gly">[</span>pkey<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        opts<span class="gly">[</span>pkey<span class="gly">]</span> = model.q.params<span class="gly">[</span>pkey<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    model.q.params = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class="covered"><code>    model.q.pkey = false;</code><span class="hits">8</span></li><li class="covered"><code>    <span class="kwrd">return</span> opts;</code><span class="hits">8</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether `s` is not undefined</span></code></li><li class=""><code><span class="C"> * @param {Mixed} s</span></code></li><li class=""><code><span class="C"> * @return {Boolean} s is undefined</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">isdef</span>(s) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> undef;</code><span class="hits">126</span></li><li class="covered"><code>    <span class="kwrd">return</span> s !== undef;</code><span class="hits">126</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define readonly property on object</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} obj</span></code></li><li class=""><code><span class="C"> * @param {String} key</span></code></li><li class=""><code><span class="C"> * @param {Mixed} value</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">defineReadonlyProp</span>(obj, key, value) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(obj, key, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: true,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: value</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">9</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Normalize id</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Mixed} id</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getInstanceId</span>(id) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'object'</span> &amp;&amp; id.constructor === Array) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = id<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> id;</code></li><li class=""><code><span class="gly">}</span></code></li></ol></pre></div></div>
<div id="lib-schema-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-schema-js" class="filename trigger" name="lib-schema-js">lib/schema.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 59%"><strong>59%</strong> [94/160]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> AbstractClass = <span class="func">require</span>(<span class="S">'./abstract-class'</span>).AbstractClass;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> getState = <span class="func">require</span>(<span class="S">'./utils'</span>).getState;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> util = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> existsSync = fs.existsSync <span class="gly">|</span><span class="gly">|</span> path.existsSync;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Export public API</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>exports.Schema = Schema;</code><span class="hits">1</span></li><li class=""><code><span class="C">// exports.AbstractClass = AbstractClass;</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Helpers</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> slice = Array.<span class="kwrd">prototype</span>.slice;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Schema - adapter-specific classes factory.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * All classes in single schema shares same adapter type and</span></code></li><li class=""><code><span class="C"> * one database connection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param name - type of schema adapter (mysql, mongoose, sequelize, redis)</span></code></li><li class=""><code><span class="C"> * @param settings - any database-specific settings which we need to</span></code></li><li class=""><code><span class="C"> * establish connection (of course it depends on specific adapter)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - host</span></code></li><li class=""><code><span class="C"> * - port</span></code></li><li class=""><code><span class="C"> * - username</span></code></li><li class=""><code><span class="C"> * - password</span></code></li><li class=""><code><span class="C"> * - database</span></code></li><li class=""><code><span class="C"> * - debug {Boolean} = false</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example Schema creation, waiting for connection callback</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * var schema = new Schema('mysql', { database: 'myapp_test' });</span></code></li><li class=""><code><span class="C"> * schema.define(...);</span></code></li><li class=""><code><span class="C"> * schema.on('connected', function () {</span></code></li><li class=""><code><span class="C"> *     ~~~C1~~~</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Schema</span>(name, settings) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> schema = this;</code><span class="hits">3</span></li><li class=""><code></code></li><li class="covered"><code>    name = name ? name.toLower<span class="kwrd">Case</span>() : <span class="S">""</span>;</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">switch</span> (name) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'sqlite'</span>:</code></li><li class="uncovered"><code>            name = <span class="S">'sqlite3'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">break</span>;</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'mysqldb'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'mariadb'</span>:</code></li><li class="uncovered"><code>            name = <span class="S">'mysql'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">break</span>;</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'mongo'</span>:</code></li><li class="uncovered"><code>            name = <span class="S">'mongodb'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">break</span>;</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'couchdb'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'couch'</span>:</code></li><li class="uncovered"><code>            name = <span class="S">'nano'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">break</span>;</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'rethinkdb'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'rethink'</span>:</code></li><li class="uncovered"><code>            name = <span class="S">'rethinkdb'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">break</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// just save everything we get</span></code></li><li class="covered"><code>    schema.name = name;</code><span class="hits">3</span></li><li class="covered"><code>    schema.settings = settings;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// Disconnected by default</span></code></li><li class="covered"><code>    schema.connected = false;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// create blank models pool</span></code></li><li class="covered"><code>    schema.models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>    schema.definitions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code>    <span class="C">// define custom types</span></code></li><li class=""><code>    schema.Text = <span class="kwrd">function</span> <span class="func">Text</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code>    schema.JSON = <span class="kwrd">function</span> <span class="func">JSON</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>    schema.Date = Date;</code><span class="hits">3</span></li><li class="covered"><code>    schema.Number = Number;</code><span class="hits">3</span></li><li class="covered"><code>    schema.String = String;</code><span class="hits">3</span></li><li class="covered"><code>    schema.Boolean = Boolean;</code><span class="hits">3</span></li><li class=""><code>    <span class="C">// and initialize schema using adapter</span></code></li><li class=""><code>    <span class="C">// this is only one initialization entry point of adapter</span></code></li><li class=""><code>    <span class="C">// this module should define `adapter` member of `this` (schema)</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> adapter;</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> name === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        adapter = name;</code></li><li class="uncovered"><code>        schema.name = adapter.name;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (name.<span class="func">match</span>(/^\<span class="C">//)) {</span></code></li><li class=""><code>        <span class="C">// try absolute path</span></code></li><li class="uncovered"><code>        adapter = <span class="func">require</span>(name);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="func">existsSync</span>(__dirname + <span class="S">'/adapters/'</span> + name + <span class="S">'.js'</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// try built-in adapter</span></code></li><li class="covered"><code>        adapter = <span class="func">require</span>(<span class="S">'./adapters/'</span> + name);</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            adapter = <span class="func">require</span>(<span class="S">'caminte-'</span> + name);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Adapter '</span> + name + <span class="S">' is not defined, try\n  npm install '</span> + name);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    adapter.<span class="func">initialize</span>(schema, <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// we have an adaper now?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!schema.adapter) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Adapter is not defined correctly: it should create `adapter` member of schema'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        schema.adapter.log = <span class="kwrd">function</span>(query, start) <span class="gly">{</span></code></li><li class="uncovered"><code>            schema.<span class="func">log</span>(query, start);</code></li><li class="covered"><code>        <span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>        schema.adapter.logger = <span class="kwrd">function</span>(query) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> log = schema.log;</code></li><li class=""><code>            <span class="kwrd">return</span> <span class="kwrd">function</span>(q) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">log</span>(q <span class="gly">|</span><span class="gly">|</span> query, t1);</code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class="covered"><code>        <span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>        schema.connected = <span class="func">getState</span>(schema);</code><span class="hits">3</span></li><li class="covered"><code>        schema.<span class="func">emit</span>(<span class="S">'connected'</span>);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(schema));</code><span class="hits">3</span></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>util.<span class="func">inherits</span>(Schema, <span class="func">require</span>(<span class="S">'events'</span>).EventEmitter);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Schema.Text = <span class="kwrd">function</span> <span class="func">Text</span>() <span class="gly">{</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>Schema.JSON = <span class="kwrd">function</span> <span class="func">JSON</span>() <span class="gly">{</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} className</span></code></li><li class=""><code><span class="C"> * @param {Object} properties - hash of class properties in format</span></code></li><li class=""><code><span class="C"> *   `{property: Type, property2: Type2, ...}`</span></code></li><li class=""><code><span class="C"> *   or</span></code></li><li class=""><code><span class="C"> *   `{property: {type: Type}, property2: {type: Type2}, ...}`</span></code></li><li class=""><code><span class="C"> * @param {Object} settings - other configuration of class</span></code></li><li class=""><code><span class="C"> * @return newly created class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example simple case</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * var User = schema.define('User', {</span></code></li><li class=""><code><span class="C"> *     email: String,</span></code></li><li class=""><code><span class="C"> *     password: String,</span></code></li><li class=""><code><span class="C"> *     birthDate: Date,</span></code></li><li class=""><code><span class="C"> *     activated: Boolean</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * @example more advanced case</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * var User = schema.define('User', {</span></code></li><li class=""><code><span class="C"> *     email: { type: String, limit: 150, index: true },</span></code></li><li class=""><code><span class="C"> *     password: { type: String, limit: 50 },</span></code></li><li class=""><code><span class="C"> *     birthDate: Date,</span></code></li><li class=""><code><span class="C"> *     registrationDate: {type: Date, default: function () { return new Date }},</span></code></li><li class=""><code><span class="C"> *     activated: { type: Boolean, default: false }</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.define = <span class="kwrd">function</span> <span class="func">defineClass</span>(className, properties, settings) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> schema = this;</code><span class="hits">5</span></li><li class="covered"><code>    <span class="kwrd">var</span> args = slice.<span class="func">call</span>(arguments);</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!className)<span class="gly">{</span></code></li><li class="uncovered"><code>        throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Class name required'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (args.length === 1)</code></li><li class="covered"><code>        properties = <span class="gly">{</span><span class="gly">}</span>, args.<span class="func">push</span>(properties);</code><span class="hits">5</span></li><li class=""><code>    <span class="kwrd">if</span> (args.length === 2)</code></li><li class="covered"><code>        settings = <span class="gly">{</span><span class="gly">}</span>, args.<span class="func">push</span>(settings);</code><span class="hits">5</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">standartize</span>(properties, settings);</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// every class can receive hash of data as optional param</span></code></li><li class=""><code>    <span class="kwrd">var</span> NewClass = <span class="kwrd">function</span> <span class="func">ModelConstructor</span>(data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!(this instanceof ModelConstructor)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">ModelConstructor</span>(data);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        AbstractClass.<span class="func">call</span>(this, data);</code><span class="hits">18</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(NewClass, <span class="S">'schema'</span>, schema);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(NewClass, <span class="S">'modelName'</span>, className);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(NewClass, <span class="S">'cache'</span>, <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(NewClass, <span class="S">'mru'</span>, <span class="gly">[</span><span class="gly">]</span>);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(NewClass, <span class="S">'relations'</span>, <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// inherit AbstractClass methods</span></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> AbstractClass) <span class="gly">{</span></code></li><li class="covered"><code>        NewClass<span class="gly">[</span>i<span class="gly">]</span> = AbstractClass<span class="gly">[</span>i<span class="gly">]</span>;</code><span class="hits">235</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> j <span class="kwrd">in</span> AbstractClass.<span class="kwrd">prototype</span>) <span class="gly">{</span></code></li><li class="covered"><code>        NewClass.<span class="kwrd">prototype</span><span class="gly">[</span>j<span class="gly">]</span> = AbstractClass.<span class="kwrd">prototype</span><span class="gly">[</span>j<span class="gly">]</span>;</code><span class="hits">85</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    NewClass.getter = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">5</span></li><li class="covered"><code>    NewClass.setter = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// store class in model pool</span></code></li><li class="covered"><code>    this.models<span class="gly">[</span>className<span class="gly">]</span> = NewClass;</code><span class="hits">5</span></li><li class=""><code>    this.definitions<span class="gly">[</span>className<span class="gly">]</span> = <span class="gly">{</span></code></li><li class=""><code>        properties: properties,</code></li><li class=""><code>        settings: settings</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// pass controll to adapter</span></code></li><li class=""><code>    this.adapter.<span class="func">define</span>(<span class="gly">{</span></code></li><li class=""><code>        model: NewClass,</code></li><li class=""><code>        properties: properties,</code></li><li class=""><code>        settings: settings</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    NewClass.<span class="kwrd">prototype</span>.<span class="func">__defineGetter__</span>(<span class="S">'id'</span>, <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this.__data.id;</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class=""><code></code></li><li class="covered"><code>    properties.id = properties.id <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span>type: Number<span class="gly">}</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    NewClass.forEachProperty = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="covered"><code>        Object.<span class="func">keys</span>(properties).<span class="func">forEach</span>(cb);</code><span class="hits">80</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    NewClass.registerProperty = <span class="kwrd">function</span>(attr) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(NewClass.<span class="kwrd">prototype</span>, attr, <span class="gly">{</span></code></li><li class=""><code>            get: <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (NewClass.getter<span class="gly">[</span>attr<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> NewClass.getter<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">call</span>(this);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">return</span> this.__data<span class="gly">[</span>attr<span class="gly">]</span>;</code><span class="hits">493</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            set: <span class="kwrd">function</span>(value) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (NewClass.setter<span class="gly">[</span>attr<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    NewClass.setter<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">call</span>(this, value);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    this.__data<span class="gly">[</span>attr<span class="gly">]</span> = value;</code><span class="hits">14</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            enumerable: true</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">45</span></li><li class=""><code></code></li><li class=""><code>        NewClass.<span class="kwrd">prototype</span>.<span class="func">__defineGetter__</span>(attr + <span class="S">'_was'</span>, <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this.__dataWas<span class="gly">[</span>attr<span class="gly">]</span>;</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">45</span></li><li class=""><code></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(NewClass.<span class="kwrd">prototype</span>, <span class="S">'_'</span> + attr, <span class="gly">{</span></code></li><li class=""><code>            get: <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> this.__data<span class="gly">[</span>attr<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            set: <span class="kwrd">function</span>(value) <span class="gly">{</span></code></li><li class="uncovered"><code>                this.__data<span class="gly">[</span>attr<span class="gly">]</span> = value;</code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            enumerable: false</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">45</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class="covered"><code>    NewClass.<span class="func">forEachProperty</span>(NewClass.registerProperty);</code><span class="hits">5</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> NewClass;</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">standartize</span>(properties, settings) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(properties).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> v = properties<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">31</span></li><li class=""><code>        <span class="kwrd">if</span> (</code></li><li class=""><code>                <span class="kwrd">typeof</span> v === <span class="S">'function'</span> <span class="gly">|</span><span class="gly">|</span></code></li><li class=""><code>                <span class="kwrd">typeof</span> v === <span class="S">'object'</span> &amp;&amp; v &amp;&amp; v.constructor.name === <span class="S">'Array'</span></code></li><li class=""><code>                ) <span class="gly">{</span></code></li><li class="covered"><code>            properties<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span>type: v<span class="gly">}</span>;</code><span class="hits">28</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class=""><code>    <span class="C">// TODO: add timestamps fields</span></code></li><li class=""><code>    <span class="C">// when present in settings: {timestamps: true}</span></code></li><li class=""><code>    <span class="C">// or {timestamps: {created: 'created_at', updated: false}}</span></code></li><li class=""><code>    <span class="C">// by default property names: createdAt, updatedAt</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define single property named `prop` on `model`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} model - name of model</span></code></li><li class=""><code><span class="C"> * @param {String} prop - name of propery</span></code></li><li class=""><code><span class="C"> * @param {Object} params - property settings</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.defineProperty = <span class="kwrd">function</span>(model, prop, params) <span class="gly">{</span></code></li><li class="covered"><code>    this.definitions<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span> = params;</code><span class="hits">9</span></li><li class="covered"><code>    this.models<span class="gly">[</span>model<span class="gly">]</span>.<span class="func">registerProperty</span>(prop);</code><span class="hits">9</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.defineProperty) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">defineProperty</span>(model, prop, params);</code><span class="hits">9</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Extend existing model with bunch of properties</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} model - name of model</span></code></li><li class=""><code><span class="C"> * @param {Object} props - hash of properties</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C21~~~</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C22~~~</span></code></li><li class=""><code><span class="C"> *     db.defineProperty('Content', 'competitionType', { type: String });</span></code></li><li class=""><code><span class="C"> *     db.defineProperty('Content', 'expiryDate', { type: Date, index: true });</span></code></li><li class=""><code><span class="C"> *     db.defineProperty('Content', 'isExpired', { type: Boolean, index: true });</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C23~~~</span></code></li><li class=""><code><span class="C"> *     ~~~C24~~~</span></code></li><li class=""><code><span class="C"> *     db.extendModel('Content', {</span></code></li><li class=""><code><span class="C"> *       competitionType: String,</span></code></li><li class=""><code><span class="C"> *       expiryDate: { type: Date, index: true },</span></code></li><li class=""><code><span class="C"> *       isExpired: { type: Boolean, index: true }</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.extendModel = <span class="kwrd">function</span>(model, props) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> t = this;</code></li><li class="uncovered"><code>    <span class="func">standartize</span>(props, <span class="gly">{</span><span class="gly">}</span>);</code></li><li class=""><code>    Object.<span class="func">keys</span>(props).<span class="func">forEach</span>(<span class="kwrd">function</span>(propName) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> definition = props<span class="gly">[</span>propName<span class="gly">]</span>;</code></li><li class="uncovered"><code>        t.<span class="func">defineProperty</span>(model, propName, definition);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Drop each model table and re-create.</span></code></li><li class=""><code><span class="C"> * This method make sense only for sql adapters.</span></code></li><li class=""><code><span class="C"> * @param {Function} cb</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @warning All data will be lost! Use autoupdate if you need your data.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.automigrate = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.<span class="func">freeze</span>();</code></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.automigrate) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.adapter.<span class="func">automigrate</span>(cb);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update existing database tables.</span></code></li><li class=""><code><span class="C"> * This method make sense only for sql adapters.</span></code></li><li class=""><code><span class="C"> * @param {Function} cb</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.autoupdate = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">freeze</span>();</code><span class="hits">10</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.autoupdate) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">autoupdate</span>(cb);</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether migrations needed</span></code></li><li class=""><code><span class="C"> * This method make sense only for sql adapters.</span></code></li><li class=""><code><span class="C"> * @param {Function} cb</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.isActual = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">freeze</span>();</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.isActual) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">isActual</span>(cb);</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>(null, true);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Log benchmarked message. Do not redefine this method, if you need to grab</span></code></li><li class=""><code><span class="C"> * chema logs, use `schema.on('log', ...)` emitter event</span></code></li><li class=""><code><span class="C"> * @param {String} sql</span></code></li><li class=""><code><span class="C"> * @param {Date} t</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @private used by adapters</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.log = <span class="kwrd">function</span>(sql, t) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.<span class="func">emit</span>(<span class="S">'log'</span>, sql, t);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Freeze schema. Behavior depends on adapter</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.freeze = <span class="kwrd">function</span> <span class="func">freeze</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.freezeSchema) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.adapter.<span class="func">freezeSchema</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return table name for specified `modelName`</span></code></li><li class=""><code><span class="C"> * @param {String} modelName</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.tableName = <span class="kwrd">function</span>(modelName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.definitions<span class="gly">[</span>modelName<span class="gly">]</span>.settings.table = this.definitions<span class="gly">[</span>modelName<span class="gly">]</span>.settings.table <span class="gly">|</span><span class="gly">|</span> modelName;</code><span class="hits">51</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define foreign key</span></code></li><li class=""><code><span class="C"> * @param {String} className</span></code></li><li class=""><code><span class="C"> * @param {String} key - name of key field</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.defineForeignKey = <span class="kwrd">function</span> <span class="func">defineForeignKey</span>(className, key) <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// quit if key already defined</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this.definitions<span class="gly">[</span>className<span class="gly">]</span>.properties<span class="gly">[</span>key<span class="gly">]</span>)</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.defineForeignKey) <span class="gly">{</span></code></li><li class=""><code>        this.adapter.<span class="func">defineForeignKey</span>(className, key, <span class="kwrd">function</span>(err, keyType) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>                throw err;</code></li><li class="uncovered"><code>            this.definitions<span class="gly">[</span>className<span class="gly">]</span>.properties<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span>type: keyType<span class="gly">}</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        this.definitions<span class="gly">[</span>className<span class="gly">]</span>.properties<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span>type: Number<span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    this.models<span class="gly">[</span>className<span class="gly">]</span>.<span class="func">registerProperty</span>(key);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Start transaction</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.beg<span class="kwrd">in</span> = <span class="kwrd">function</span> beg<span class="kwrd">in</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>        callback = <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> err;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.adapter.beg<span class="kwrd">in</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'TRANSACTION::begin method not defined for this adapter'</span>));</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        this.adapter.beg<span class="kwrd">in</span>(params, callback);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Commit transaction</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.commit = <span class="kwrd">function</span> <span class="func">commit</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>        callback = <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> err;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.adapter.commit === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'TRANSACTION::commit method not defined for this adapter'</span>));</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        this.adapter.<span class="func">commit</span>(params, callback);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Rollback transaction</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.rollback = <span class="kwrd">function</span> <span class="func">rollback</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>        callback = <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> err;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.adapter.rollback === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'TRANSACTION::rollback method not defined for this adapter'</span>));</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        this.adapter.<span class="func">rollback</span>(params, callback);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Close database connection</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.disconnect = <span class="kwrd">function</span> <span class="func">disconnect</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.adapter.disconnect === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this.connected = false;</code><span class="hits">1</span></li><li class="covered"><code>        this.adapter.<span class="func">disconnect</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Returns an array of model names created on this instance of Schema.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ####Note:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * _Does not include names of models created using `connection.model()`._</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @api public</span></code></li><li class=""><code><span class="C"> * @return {Array}</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.modelNames = <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> names = Object.<span class="func">keys</span>(this.models);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> names;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Defines a model or retrieves it.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Models defined on the `mongoose` instance are available to all connection created by the same `mongoose` instance.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ####Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     var mongoose = require('mongoose');</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C26~~~</span></code></li><li class=""><code><span class="C"> *     mongoose.model('Actor', new Schema({ name: String }));</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C27~~~</span></code></li><li class=""><code><span class="C"> *     var conn = mongoose.createConnection(..);</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C28~~~</span></code></li><li class=""><code><span class="C"> *     var Actor = conn.model('Actor');</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * _When no `collection` argument is passed, Mongoose produces a collection name by passing the model `name` to the [utils.toCollectionName](#utils_exports.toCollectionName) method. This method pluralizes the name. If you don't like this behavior, either pass a collection name or set your schemas collection name option._</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ####Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     var schema = new Schema({ name: String }, { collection: 'actor' });</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C29~~~</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     schema.set('collection', 'actor');</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     ~~~C30~~~</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     var collectionName = 'actor'</span></code></li><li class=""><code><span class="C"> *     var M = mongoose.model('Actor', schema, collectionName)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name model name</span></code></li><li class=""><code><span class="C"> * @param {Schema} [schema]</span></code></li><li class=""><code><span class="C"> * @param {String} [collection] name (optional, induced from model name)</span></code></li><li class=""><code><span class="C"> * @param {Boolean} [skipInit] whether to skip initialization (defaults to false)</span></code></li><li class=""><code><span class="C"> * @api public</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class=""><code>Schema.<span class="kwrd">prototype</span>.model = <span class="kwrd">function</span>(name, schema) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'string'</span> === <span class="kwrd">typeof</span> schema) <span class="gly">{</span></code></li><li class="uncovered"><code>        schema = false;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> schema === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        schema = <span class="kwrd">new</span> <span class="func">Schema</span>(schema);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> model;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// connection.model() may be passing a different schema for</span></code></li><li class=""><code>    <span class="C">// an existing model name. in this case don't read from cache.</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this.models<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        model = this.models<span class="gly">[</span>name<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> model;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define hidden property</span></code></li><li class=""><code><span class="C"> * @param {Object} where</span></code></li><li class=""><code><span class="C"> * @param {String} property</span></code></li><li class=""><code><span class="C"> * @param {mixed} value</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">hiddenProperty</span>(where, property, value) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(where, property, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: false,</code></li><li class=""><code>        value: value</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">25</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define readonly property on object</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} obj</span></code></li><li class=""><code><span class="C"> * @param {String} key</span></code></li><li class=""><code><span class="C"> * @param {Mixed} value</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">defineReadonlyProp</span>(obj, key, value) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(obj, key, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: true,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: value</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li></ol></pre></div></div>
<div id="lib-validatable-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-validatable-js" class="filename trigger" name="lib-validatable-js">lib/validatable.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 78%"><strong>78%</strong> [92/118]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code>exports.Validatable = Validatable;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validation encapsulated in this abstract class.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Basically validation configurators is just class methods, which adds validations</span></code></li><li class=""><code><span class="C"> * configs to AbstractClass._validations. Each of this validations run when</span></code></li><li class=""><code><span class="C"> * `obj.isValid()` method called.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Each configurator can accept n params (n-1 field names and one config). Config</span></code></li><li class=""><code><span class="C"> * is {Object} depends on specific validation, but all of them has one common part:</span></code></li><li class=""><code><span class="C"> * `message` member. It can be just string, when only one situation possible,</span></code></li><li class=""><code><span class="C"> * e.g. `Post.validatesPresenceOf('title', { message: 'can not be blank' });`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * In more complicated cases it can be {Hash} of messages (for each case):</span></code></li><li class=""><code><span class="C"> * `User.validatesLengthOf('password', { min: 6, max: 20, message: {min: 'too short', max: 'too long'}});`</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Validatable</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// validatable class</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate presence. This validation fails when validated field is blank.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message "can't be blank"</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example presence of title</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * Post.validatesPresenceOf('title');</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * @example with custom message</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * Post.validatesPresenceOf('title', {message: 'Can not be blank'});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validatePresence</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesPresenceOf = <span class="func">getConfigurator</span>(<span class="S">'presence'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate length. Three kinds of validations: min, max, is.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error messages:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - min: too short</span></code></li><li class=""><code><span class="C"> * - max: too long</span></code></li><li class=""><code><span class="C"> * - is:  length is wrong</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example length validations</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('password', {min: 7});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('email', {max: 100});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('state', {is: 2});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('nick', {min: 3, max: 15});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * @example length validations with custom error messages</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('password', {min: 7, message: {min: 'too weak'}});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('state', {is: 2, message: {is: 'is not valid state name'}});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateLength</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesLengthOf = <span class="func">getConfigurator</span>(<span class="S">'length'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate numericality.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesNumericalityOf('age', { message: { number: '...' }});</span></code></li><li class=""><code><span class="C"> * User.validatesNumericalityOf('age', {int: true, message: { int: '...' }});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error messages:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - number: is not a number</span></code></li><li class=""><code><span class="C"> * - int: is not an integer</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateNumericality</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesNumericalityOf = <span class="func">getConfigurator</span>(<span class="S">'numericality'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate inclusion in set</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesInclusionOf('gender', {in: ['male', 'female']});</span></code></li><li class=""><code><span class="C"> * User.validatesInclusionOf('role', {</span></code></li><li class=""><code><span class="C"> *     in: ['admin', 'moderator', 'user'], message: 'is not allowed'</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is not included in the list</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateInclusion</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesInclusionOf = <span class="func">getConfigurator</span>(<span class="S">'inclusion'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate exclusion</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example `Company.validatesExclusionOf('domain', {in: ['www', 'admin']});`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is reserved</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateExclusion</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesExclusionOf = <span class="func">getConfigurator</span>(<span class="S">'exclusion'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate format</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is invalid</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateFormat</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesFormatOf = <span class="func">getConfigurator</span>(<span class="S">'format'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate using custom validator</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is invalid</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     User.validate('name', customValidator, {message: 'Bad name'});</span></code></li><li class=""><code><span class="C"> *     function customValidator(err) {</span></code></li><li class=""><code><span class="C"> *         if (this.name === 'bad') err();</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> *     var user = new User({name: 'Peter'});</span></code></li><li class=""><code><span class="C"> *     user.isValid(); ~~~C1~~~</span></code></li><li class=""><code><span class="C"> *     user.name = 'bad';</span></code></li><li class=""><code><span class="C"> *     user.isValid(); ~~~C2~~~</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateCustom</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validate = <span class="func">getConfigurator</span>(<span class="S">'custom'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate using custom async validator</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is invalid</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     User.validateAsync('name', customValidator, {message: 'Bad name'});</span></code></li><li class=""><code><span class="C"> *     function customValidator(err, done) {</span></code></li><li class=""><code><span class="C"> *         process.nextTick(function () {</span></code></li><li class=""><code><span class="C"> *             if (this.name === 'bad') err();</span></code></li><li class=""><code><span class="C"> *             done();</span></code></li><li class=""><code><span class="C"> *         });</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> *     var user = new User({name: 'Peter'});</span></code></li><li class=""><code><span class="C"> *     user.isValid(); ~~~C3~~~</span></code></li><li class=""><code><span class="C"> *     user.isValid(function (isValid) {</span></code></li><li class=""><code><span class="C"> *         isValid; ~~~C4~~~</span></code></li><li class=""><code><span class="C"> *     })</span></code></li><li class=""><code><span class="C"> *     user.name = 'bad';</span></code></li><li class=""><code><span class="C"> *     user.isValid(); ~~~C5~~~</span></code></li><li class=""><code><span class="C"> *     user.isValid(function (isValid) {</span></code></li><li class=""><code><span class="C"> *         isValid; ~~~C6~~~</span></code></li><li class=""><code><span class="C"> *     })</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @async</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateCustom</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validateAsync = <span class="func">getConfigurator</span>(<span class="S">'custom'</span>, <span class="gly">{</span>async: true<span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate uniqueness</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is not unique</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @async</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateUniqueness</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesUniquenessOf = <span class="func">getConfigurator</span>(<span class="S">'uniqueness'</span>, <span class="gly">{</span>async: true<span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// implementation of validators</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Presence validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validatePresence</span>(attr, conf, err) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">blank</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">err</span>();</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Length validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateLength</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code><span class="hits">5</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> len = this<span class="gly">[</span>attr<span class="gly">]</span>.length;</code><span class="hits">5</span></li><li class=""><code>    <span class="kwrd">if</span> (conf.m<span class="kwrd">in</span> &amp;&amp; len &lt; conf.m<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">err</span>(<span class="S">'min'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (conf.max &amp;&amp; len &gt; conf.max) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">err</span>(<span class="S">'max'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (conf.is &amp;&amp; len !== conf.is) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">err</span>(<span class="S">'is'</span>);</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Numericality validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateNumericality</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this<span class="gly">[</span>attr<span class="gly">]</span> !== <span class="S">'number'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">err</span>(<span class="S">'number'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (conf.int &amp;&amp; this<span class="gly">[</span>attr<span class="gly">]</span> !== Math.<span class="func">round</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">err</span>(<span class="S">'int'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Inclusion validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateInclusion</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!~conf.<span class="kwrd">in</span>.<span class="func">indexOf</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">err</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Exclusion validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateExclusion</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (~conf.<span class="kwrd">in</span>.<span class="func">indexOf</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">err</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Format validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateFormat</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this<span class="gly">[</span>attr<span class="gly">]</span> === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!this<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">match</span>(conf<span class="gly">[</span><span class="S">'with'</span><span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">err</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">err</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Custom validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> * @param {Function} done</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateCustom</span>(attr, conf, err, done) <span class="gly">{</span></code></li><li class="uncovered"><code>    conf.customValidator.<span class="func">call</span>(this, err, done);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Uniqueness validator</span></code></li><li class=""><code><span class="C"> * @param {mixed} attr</span></code></li><li class=""><code><span class="C"> * @param {mixed} conf</span></code></li><li class=""><code><span class="C"> * @param {mixed} err</span></code></li><li class=""><code><span class="C"> * @param {Function} done</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateUniqueness</span>(attr, conf, err, done) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cond = <span class="gly">{</span>where: <span class="gly">{</span><span class="gly">}</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class="covered"><code>    cond.where<span class="gly">[</span>attr<span class="gly">]</span> = this<span class="gly">[</span>attr<span class="gly">]</span>;</code><span class="hits">8</span></li><li class=""><code>    this.constructor.<span class="func">all</span>(cond, <span class="kwrd">function</span> (error, found) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (found.length &gt; 1) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">err</span>();</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (found.length === 1 &amp;&amp; (!this.id <span class="gly">|</span><span class="gly">|</span> !found<span class="gly">[</span>0<span class="gly">]</span>.id <span class="gly">|</span><span class="gly">|</span> found<span class="gly">[</span>0<span class="gly">]</span>.id.<span class="func">toString</span>() !== this.id.<span class="func">toString</span>())) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">err</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">done</span>();</code><span class="hits">8</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">8</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> validators = <span class="gly">{</span></code></li><li class=""><code>    presence:     validatePresence,</code></li><li class=""><code>    length:       validateLength,</code></li><li class=""><code>    numericality: validateNumericality,</code></li><li class=""><code>    inclusion:    validateInclusion,</code></li><li class=""><code>    exclusion:    validateExclusion,</code></li><li class=""><code>    format:       validateFormat,</code></li><li class=""><code>    custom:       validateCustom,</code></li><li class=""><code>    uniqueness:   validateUniqueness</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getConfigurator</span>(name, opts) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> () <span class="gly">{</span></code><span class="hits">9</span></li><li class="covered"><code>        <span class="func">configure</span>(this, name, arguments, opts);</code><span class="hits">5</span></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * This method performs validation, triggers validation hooks.</span></code></li><li class=""><code><span class="C"> * Before validation `obj.errors` collection cleaned.</span></code></li><li class=""><code><span class="C"> * Each validation can add errors to `obj.errors` collection.</span></code></li><li class=""><code><span class="C"> * If collection is not blank, validation failed.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @warning This method can be called as sync only when no async validation</span></code></li><li class=""><code><span class="C"> * configured. It's strongly recommended to run all validations as asyncronous.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} callback called with (valid)</span></code></li><li class=""><code><span class="C"> * @return {Boolean} true if no async validation configured and all passed</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example ExpressJS controller: render user if valid, show flash otherwise</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * user.isValid(function (valid) {</span></code></li><li class=""><code><span class="C"> *     if (valid) res.render({user: user});</span></code></li><li class=""><code><span class="C"> *     else res.flash('error', 'User is not valid'), console.log(user.errors), res.redirect('/users');</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Validatable.<span class="kwrd">prototype</span>.isValid = <span class="kwrd">function</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> valid = true, inst = this, wait = 0, async = false;</code><span class="hits">29</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// exit with success when no errors</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.constructor._validations) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">cleanErrors</span>(this);</code><span class="hits">11</span></li><li class=""><code>        <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(valid);</code><span class="hits">11</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> valid;</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'errors'</span>, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="kwrd">new</span> Errors</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">trigger</span>(<span class="S">'validation'</span>, <span class="kwrd">function</span> (validationsDone) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> inst = this;</code><span class="hits">18</span></li><li class=""><code>        this.constructor._validations.<span class="func">forEach</span>(<span class="kwrd">function</span> (v) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (v<span class="gly">[</span>2<span class="gly">]</span> &amp;&amp; v<span class="gly">[</span>2<span class="gly">]</span>.async) <span class="gly">{</span></code></li><li class="covered"><code>                async = true;</code><span class="hits">8</span></li><li class="covered"><code>                wait += 1;</code><span class="hits">8</span></li><li class="covered"><code>                <span class="func">validationFailed</span>(inst, v, done);</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="func">validationFailed</span>(inst, v)) <span class="gly">{</span></code></li><li class="covered"><code>                    valid = false;</code><span class="hits">6</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!async) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">validationsDone</span>();</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> asyncFail = false;</code><span class="hits">18</span></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">done</span>(fail) <span class="gly">{</span></code></li><li class="covered"><code>            asyncFail = asyncFail <span class="gly">|</span><span class="gly">|</span> fail;</code><span class="hits">8</span></li><li class=""><code>            <span class="kwrd">if</span> (--wait === 0 &amp;&amp; callback) <span class="gly">{</span></code></li><li class=""><code>                validationsDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">if</span>( valid &amp;&amp; !asyncFail ) <span class="func">cleanErrors</span>(inst);</code><span class="hits">8</span></li><li class="covered"><code>                    <span class="func">callback</span>(valid &amp;&amp; !asyncFail);</code><span class="hits">8</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!async) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (valid) <span class="func">cleanErrors</span>(this);</code><span class="hits">10</span></li><li class="covered"><code>        <span class="kwrd">if</span> (callback) <span class="func">callback</span>(valid);</code><span class="hits">10</span></li><li class="covered"><code>        <span class="kwrd">return</span> valid;</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// in case of async validation we should return undefined here,</span></code></li><li class=""><code>        <span class="C">// because not all validations are finished yet</span></code></li><li class="covered"><code>        <span class="kwrd">return</span>;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">cleanErrors</span>(inst) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(inst, <span class="S">'errors'</span>, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: false</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">23</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validationFailed</span>(inst, v, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> attr = v<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">44</span></li><li class="covered"><code>    <span class="kwrd">var</span> conf = v<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">44</span></li><li class="covered"><code>    <span class="kwrd">var</span> opts = v<span class="gly">[</span>2<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">44</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> attr !== <span class="S">'string'</span>) <span class="kwrd">return</span> false;</code><span class="hits">44</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// here we should check skip validation conditions (if, unless)</span></code></li><li class=""><code>    <span class="C">// that can be specified in conf</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">skipValidation</span>(inst, conf, <span class="S">'if'</span>)) <span class="kwrd">return</span> false;</code><span class="hits">43</span></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">skipValidation</span>(inst, conf, <span class="S">'unless'</span>)) <span class="kwrd">return</span> false;</code><span class="hits">39</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> fail = false;</code><span class="hits">39</span></li><li class="covered"><code>    <span class="kwrd">var</span> validator = validators<span class="gly">[</span>conf.validation<span class="gly">]</span>;</code><span class="hits">39</span></li><li class="covered"><code>    <span class="kwrd">var</span> validatorArguments = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">39</span></li><li class="covered"><code>    validatorArguments.<span class="func">push</span>(attr);</code><span class="hits">39</span></li><li class="covered"><code>    validatorArguments.<span class="func">push</span>(conf);</code><span class="hits">39</span></li><li class=""><code>    validatorArguments.<span class="func">push</span>(<span class="kwrd">function</span> <span class="func">onerror</span>(kind) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> message;</code><span class="hits">7</span></li><li class=""><code>        <span class="kwrd">if</span> (conf.message) <span class="gly">{</span></code></li><li class="uncovered"><code>            message = conf.message;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!message &amp;&amp; defaultMessages<span class="gly">[</span>conf.validation<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            message = defaultMessages<span class="gly">[</span>conf.validation<span class="gly">]</span>;</code><span class="hits">7</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!message) <span class="gly">{</span></code></li><li class="uncovered"><code>            message = <span class="S">'is invalid'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (kind) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (message<span class="gly">[</span>kind<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// get deeper</span></code></li><li class="covered"><code>                message = message<span class="gly">[</span>kind<span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (defaultMessages.common<span class="gly">[</span>kind<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                message = defaultMessages.common<span class="gly">[</span>kind<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        inst.errors.<span class="func">add</span>(attr, message);</code><span class="hits">7</span></li><li class="covered"><code>        fail = true;</code><span class="hits">7</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">39</span></li><li class=""><code>    <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class=""><code>        validatorArguments.<span class="func">push</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>(fail);</code><span class="hits">8</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    validator.<span class="func">apply</span>(inst, validatorArguments);</code><span class="hits">39</span></li><li class="covered"><code>    <span class="kwrd">return</span> fail;</code><span class="hits">39</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">skipValidation</span>(inst, conf, kind) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> doValidate = true;</code><span class="hits">87</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> conf<span class="gly">[</span>kind<span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        doValidate = conf<span class="gly">[</span>kind<span class="gly">]</span>.<span class="func">call</span>(inst);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="kwrd">if</span> (kind === <span class="S">'unless'</span>) doValidate = !doValidate;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> conf<span class="gly">[</span>kind<span class="gly">]</span> === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> inst<span class="gly">[</span>conf<span class="gly">[</span>kind<span class="gly">]</span><span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            doValidate = inst<span class="gly">[</span>conf<span class="gly">[</span>kind<span class="gly">]</span><span class="gly">]</span>.<span class="func">call</span>(inst);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (kind === <span class="S">'unless'</span>) doValidate = !doValidate;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (inst.__data.<span class="func">hasOwnProperty</span>(conf<span class="gly">[</span>kind<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>            doValidate = inst<span class="gly">[</span>conf<span class="gly">[</span>kind<span class="gly">]</span><span class="gly">]</span>;</code><span class="hits">14</span></li><li class="covered"><code>            <span class="kwrd">if</span> (kind === <span class="S">'unless'</span>) doValidate = !doValidate;</code><span class="hits">14</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            doValidate = kind === <span class="S">'if'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> !doValidate;</code><span class="hits">87</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> defaultMessages = <span class="gly">{</span></code></li><li class=""><code>    presence: <span class="S">'can\'t be blank'</span>,</code></li><li class=""><code>    length: <span class="gly">{</span></code></li><li class=""><code>        m<span class="kwrd">in</span>: <span class="S">'too short'</span>,</code></li><li class=""><code>        max: <span class="S">'too long'</span>,</code></li><li class=""><code>        is: <span class="S">'length is wrong'</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    common: <span class="gly">{</span></code></li><li class=""><code>        blank: <span class="S">'is blank'</span>,</code></li><li class=""><code>        <span class="S">'null'</span>: <span class="S">'is null'</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    numericality: <span class="gly">{</span></code></li><li class=""><code>        <span class="S">'int'</span>: <span class="S">'is not an integer'</span>,</code></li><li class=""><code>        <span class="S">'number'</span>: <span class="S">'is not a number'</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    inclusion: <span class="S">'is not included in the list'</span>,</code></li><li class=""><code>    exclusion: <span class="S">'is reserved'</span>,</code></li><li class=""><code>    uniqueness: <span class="S">'is not unique'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">nullCheck</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> isNull = this<span class="gly">[</span>attr<span class="gly">]</span> === null <span class="gly">|</span><span class="gly">|</span> !(attr <span class="kwrd">in</span> this);</code><span class="hits">5</span></li><li class=""><code>    <span class="kwrd">if</span> (isNull) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!conf.allowNull) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">err</span>(<span class="S">'null'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> true;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">blank</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!conf.allowBlank) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">err</span>(<span class="S">'blank'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> true;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> false;</code><span class="hits">5</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return true when v is undefined, blank array, null or empty string</span></code></li><li class=""><code><span class="C"> * otherwise returns false</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Mix} v</span></code></li><li class=""><code><span class="C"> * @returns {Boolean} whether `v` blank or not</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">blank</span>(v) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> v === <span class="S">'undefined'</span>) <span class="kwrd">return</span> true;</code><span class="hits">31</span></li><li class="covered"><code>    <span class="kwrd">if</span> (v instanceof Array &amp;&amp; v.length === 0) <span class="kwrd">return</span> true;</code><span class="hits">31</span></li><li class="covered"><code>    <span class="kwrd">if</span> (v === null) <span class="kwrd">return</span> true;</code><span class="hits">27</span></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> v === <span class="S">'string'</span> &amp;&amp; v === <span class="S">''</span>) <span class="kwrd">return</span> true;</code><span class="hits">27</span></li><li class="covered"><code>    <span class="kwrd">return</span> false;</code><span class="hits">27</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">configure</span>(cls, validation, args, opts) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!cls._validations) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(cls, <span class="S">'_validations'</span>, <span class="gly">{</span></code></li><li class=""><code>            writable: true,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            enumerable: false,</code></li><li class=""><code>            value: <span class="gly">[</span><span class="gly">]</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    args = <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(args);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="kwrd">var</span> conf;</code><span class="hits">5</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        conf = args.<span class="func">pop</span>();</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        conf = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (validation === <span class="S">'custom'</span> &amp;&amp; <span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        conf.customValidator = args.<span class="func">pop</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    conf.validation = validation;</code><span class="hits">5</span></li><li class=""><code>    args.<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class="covered"><code>        cls._validations.<span class="func">push</span>(<span class="gly">[</span>attr, conf, opts<span class="gly">]</span>);</code><span class="hits">6</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Errors</span>() <span class="gly">{</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Errors.<span class="kwrd">prototype</span>.add = <span class="kwrd">function</span> (field, message) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this<span class="gly">[</span>field<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this<span class="gly">[</span>field<span class="gly">]</span> = <span class="gly">[</span>message<span class="gly">]</span>;</code><span class="hits">7</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        this<span class="gly">[</span>field<span class="gly">]</span>.<span class="func">push</span>(message);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-sql-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-sql-js" class="filename trigger" name="lib-sql-js">lib/sql.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 34%"><strong>34%</strong> [28/83]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code>module.exports = BaseSQL;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Base SQL class</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">BaseSQL</span>() <span class="gly">{</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.query = <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'query method should be declared in adapter'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.command = <span class="kwrd">function</span>(sql, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.<span class="func">query</span>(sql, callback);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.queryOne = <span class="kwrd">function</span>(sql, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">return</span> this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err, data<span class="gly">[</span>0<span class="gly">]</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.table = <span class="kwrd">function</span>(model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this._models<span class="gly">[</span>model<span class="gly">]</span>.model.schema.<span class="func">tableName</span>(model);</code><span class="hits">51</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.escapeName = <span class="kwrd">function</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>    throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'escapeName method should be declared in adapter'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.tableEscaped = <span class="kwrd">function</span>(model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.<span class="func">escapeName</span>(this.<span class="func">table</span>(model));</code><span class="hits">51</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.define = <span class="kwrd">function</span>(descr) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!descr.settings)</code></li><li class="covered"><code>        descr.settings = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    this._models<span class="gly">[</span>descr.model.modelName<span class="gly">]</span> = descr;</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.defineProperty = <span class="kwrd">function</span>(model, prop, params) <span class="gly">{</span></code></li><li class="covered"><code>    this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span> = params;</code><span class="hits">9</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.save = <span class="kwrd">function</span>(model, data, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> sql = <span class="S">'UPDATE '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' SET '</span> + this.<span class="func">toFields</span>(model, data) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + data.id;</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.exists = <span class="kwrd">function</span>(model, id, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    id = <span class="func">getInstanceId</span>(id);</code></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT 1 FROM '</span> +</code></li><li class="uncovered"><code>            this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + id + <span class="S">' LIMIT 1'</span>;</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>        <span class="func">callback</span>(null, data.length === 1);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.findById = <span class="kwrd">function</span> <span class="func">findById</span>(model, id, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    id = <span class="func">getInstanceId</span>(id);</code></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT * FROM '</span> +</code></li><li class="uncovered"><code>            this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + id + <span class="S">' LIMIT 1'</span>;</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (data &amp;&amp; data.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>            data<span class="gly">[</span>0<span class="gly">]</span>.id = id;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            data = <span class="gly">[</span>null<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err, this.<span class="func">fromDatabase</span>(model, data<span class="gly">[</span>0<span class="gly">]</span>));</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.remove = <span class="kwrd">function</span> <span class="func">remove</span>(model, cond, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this, sql = <span class="S">'DELETE FROM '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (!cond) <span class="gly">{</span></code></li><li class="uncovered"><code>        cond = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (cond.where) <span class="gly">{</span></code></li><li class="uncovered"><code>        sql += self.<span class="func">buildWhere</span>(cond.where, self, model);</code></li><li class=""><code>        self.<span class="func">command</span>(sql, <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">callback</span>(<span class="S">'Undefined cond.where'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'DELETE FROM '</span> +</code></li><li class="uncovered"><code>            this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + <span class="func">getInstanceId</span>(id);</code></li><li class=""><code>    this.<span class="func">command</span>(sql, <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">command</span>(<span class="S">'DELETE FROM '</span> + this.<span class="func">tableEscaped</span>(model), <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, cond) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this, sql = <span class="S">'SELECT count(*) as cnt FROM '</span> + self.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (cond.where) <span class="gly">{</span></code></li><li class="uncovered"><code>        sql += self.<span class="func">buildWhere</span>(cond.where, self, model);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    self.<span class="func">queryOne</span>(sql, <span class="kwrd">function</span>(err, res) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err)</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class="uncovered"><code>        <span class="func">callback</span>(err, res &amp;&amp; res.cnt);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttrs</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    data.id = <span class="func">getInstanceId</span>(id);</code></li><li class="uncovered"><code>    this.<span class="func">save</span>(model, data, cb);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.disconnect = <span class="kwrd">function</span> <span class="func">disconnect</span>() <span class="gly">{</span></code></li><li class="covered"><code>    this.client.<span class="func">end</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.automigrate = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> wait = 0;</code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span>(model) <span class="gly">{</span></code></li><li class="uncovered"><code>        wait += 1;</code></li><li class=""><code>        self.<span class="func">dropTable</span>(model, <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                console.<span class="func">log</span>(err);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            self.<span class="func">createTable</span>(model, <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                    console.<span class="func">log</span>(err);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="func">done</span>();</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="kwrd">if</span> (wait === 0) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>() <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 &amp;&amp; cb) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">cb</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.dropTable = <span class="kwrd">function</span>(model, cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.<span class="func">command</span>(<span class="S">'DROP TABLE IF EXISTS '</span> + this.<span class="func">tableEscaped</span>(model), cb);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.<span class="kwrd">prototype</span>.createTable = <span class="kwrd">function</span>(model, indexes, cb) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> indexes) <span class="gly">{</span></code></li><li class="uncovered"><code>        cb = indexes;</code></li><li class="uncovered"><code>        indexes = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">command</span>(<span class="S">'CREATE TABLE '</span> + this.<span class="func">tableEscaped</span>(model) +</code></li><li class=""><code>                <span class="S">' (\n  '</span> + this.<span class="func">propertiesSQL</span>(model) + <span class="S">'\n) '</span> + <span class="S">'CHARSET=utf8;'</span>, cb); </code></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(err) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(this._models<span class="gly">[</span>model<span class="gly">]</span>.properties, err);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Normalize id</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Mixed} id</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getInstanceId</span>(id) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'object'</span> &amp;&amp; id.constructor === Array) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = id<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> id;</code></li><li class=""><code><span class="gly">}</span></code></li></ol></pre></div></div>
<div id="lib-query-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-query-js" class="filename trigger" name="lib-query-js">lib/query.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 5%"><strong>5%</strong> [4/82]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/*</span></code></li><li class=""><code><span class="C"> * Copyright 2013 Aelxey Gordeyev &lt;aleksej@gordejev.lv&gt;.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./utils'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> helpers = utils.helpers;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Query class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @api private</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} model</span></code></li><li class=""><code><span class="C"> * @param {String} action</span></code></li><li class=""><code><span class="C"> * @param {mixed} conditions</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Query</span>(model, action, conditions) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    self.model = model;</code></li><li class="uncovered"><code>    self.action = action <span class="gly">|</span><span class="gly">|</span> <span class="S">'all'</span>;</code></li><li class=""><code>    self.q = <span class="gly">{</span></code></li><li class=""><code>        conditions: <span class="gly">{</span><span class="gly">}</span>,</code></li><li class=""><code>        params: <span class="gly">{</span><span class="gly">}</span>,</code></li><li class=""><code>        pkey: false,</code></li><li class=""><code>        fields: false</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> conditions === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        self.q.conditions = helpers.<span class="func">merge</span>(self.q.conditions, conditions);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">[</span><span class="S">'all'</span>, <span class="S">'run'</span>, <span class="S">'exec'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(method) <span class="gly">{</span></code></li><li class=""><code>        self<span class="gly">[</span>method<span class="gly">]</span> = <span class="kwrd">function</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>                callback = params;</code></li><li class="uncovered"><code>                params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            params = <span class="func">buildQuery</span>(params, this);</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> action = self.action ? self.action : <span class="S">'all'</span>;</code></li><li class="uncovered"><code>            self.model<span class="gly">[</span>action<span class="gly">]</span>(params, callback);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">[</span><span class="S">'find'</span>, <span class="S">'findOne'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(method) <span class="gly">{</span></code></li><li class=""><code>        self<span class="gly">[</span>method<span class="gly">]</span> = <span class="kwrd">function</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>                callback = params;</code></li><li class="uncovered"><code>                params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            params = <span class="func">buildQuery</span>(params, this);</code></li><li class="uncovered"><code>            self.model<span class="gly">[</span>method<span class="gly">]</span>(params, callback);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">[</span><span class="S">'skip'</span>, <span class="S">'limit'</span>, <span class="S">'order'</span>, <span class="S">'sort'</span>, <span class="S">'group'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(method) <span class="gly">{</span></code></li><li class=""><code>        self<span class="gly">[</span>method<span class="gly">]</span> = <span class="kwrd">function</span>(key, value) <span class="gly">{</span></code></li><li class="uncovered"><code>            this.q.pkey = false;</code></li><li class=""><code>            <span class="kwrd">if</span> (method === <span class="S">'sort'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                method = <span class="S">'order'</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (/^-/.<span class="func">test</span>(key)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    this.q.params<span class="gly">[</span>method<span class="gly">]</span> = key.<span class="func">replace</span>(/^-/, <span class="S">""</span>) + <span class="S">' DESC'</span>;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    this.q.params<span class="gly">[</span>method<span class="gly">]</span> = key;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                this.q.params<span class="gly">[</span>method<span class="gly">]</span> = key + <span class="S">' '</span> + value;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    self.asc = <span class="kwrd">function</span>(value) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.q.pkey = false;</code></li><li class="uncovered"><code>        this.q.params<span class="gly">[</span><span class="S">'order'</span><span class="gly">]</span> = value + <span class="S">' ASC'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    self.desc = <span class="kwrd">function</span>(value) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.q.pkey = false;</code></li><li class="uncovered"><code>        this.q.params<span class="gly">[</span><span class="S">'order'</span><span class="gly">]</span> = value + <span class="S">' DESC'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    self.where = <span class="kwrd">function</span>(key, value) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            this.q.pkey = key;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            this.q.pkey = false;</code></li><li class="uncovered"><code>            this.q.conditions<span class="gly">[</span>key<span class="gly">]</span> = value;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    self.or = <span class="kwrd">function</span>(values) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (Array.<span class="func">isArray</span>(values)) <span class="gly">{</span></code></li><li class="uncovered"><code>            this.q.conditions<span class="gly">[</span><span class="S">'or'</span><span class="gly">]</span> = values;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    self.range = <span class="kwrd">function</span>(key, from, to) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> to === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (this.q.pkey) <span class="gly">{</span></code></li><li class="uncovered"><code>                to = from;</code></li><li class="uncovered"><code>                from = key;</code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span>.gt = from;</code></li><li class="uncovered"><code>                this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span>.lt = to;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            this.q.pkey = false;</code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.q.conditions<span class="gly">[</span>key<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                this.q.conditions<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            this.q.conditions<span class="gly">[</span>key<span class="gly">]</span>.gt = from;</code></li><li class="uncovered"><code>            this.q.conditions<span class="gly">[</span>key<span class="gly">]</span>.lt = to;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">[</span><span class="S">'gt'</span>, <span class="S">'gte'</span>, <span class="S">'lt'</span>, <span class="S">'lte'</span>, <span class="S">'in'</span>, <span class="S">'inq'</span>, <span class="S">'ne'</span>, <span class="S">'neq'</span>, <span class="S">'nin'</span>, <span class="S">'regex'</span>, <span class="S">'like'</span>, <span class="S">'nlike'</span>, <span class="S">'between'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(method) <span class="gly">{</span></code></li><li class=""><code>        self<span class="gly">[</span>method<span class="gly">]</span> = <span class="kwrd">function</span>(key, value) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (this.q.pkey) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                        this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                    this.q.conditions<span class="gly">[</span>this.q.pkey<span class="gly">]</span><span class="gly">[</span>method<span class="gly">]</span> = key;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                this.q.pkey = false;</code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.q.conditions<span class="gly">[</span>key<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    this.q.conditions<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                this.q.conditions<span class="gly">[</span>key<span class="gly">]</span><span class="gly">[</span>method<span class="gly">]</span> = value;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    self.slice = <span class="kwrd">function</span>(values) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (Array.<span class="func">isArray</span>(values)) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> values<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                this.q.params<span class="gly">[</span><span class="S">'limit'</span><span class="gly">]</span> = values<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                this.q.params<span class="gly">[</span><span class="S">'skip'</span><span class="gly">]</span> = values<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class="uncovered"><code>                this.q.params<span class="gly">[</span><span class="S">'limit'</span><span class="gly">]</span> = values<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Destroy records</span></code></li><li class=""><code><span class="C">     * @param {Object} params</span></code></li><li class=""><code><span class="C">     * @param {Function} callback</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    self.remove = <span class="kwrd">function</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="uncovered"><code>            callback = params;</code></li><li class="uncovered"><code>            params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        params = <span class="func">buildQuery</span>(params, this);</code></li><li class="uncovered"><code>        self.model.<span class="func">remove</span>(params, callback);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildQuery</span>(opts, query) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> opts.where === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            opts.where = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        opts.where = helpers.<span class="func">merge</span>(opts.where, query.q.conditions);</code></li><li class="uncovered"><code>        query.q.conditions = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> pkey <span class="kwrd">in</span> query.q.params) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> opts<span class="gly">[</span>pkey<span class="gly">]</span> === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                opts<span class="gly">[</span>pkey<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            opts<span class="gly">[</span>pkey<span class="gly">]</span> = query.q.params<span class="gly">[</span>pkey<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        query.q.params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>        query.q.pkey = false;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> opts;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Exports.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class="covered"><code>module.exports = exports = Query;</code><span class="hits">1</span></li></ol></pre></div></div>
<div id="lib-utils-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-utils-js" class="filename trigger" name="lib-utils-js">lib/utils.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 35%"><strong>35%</strong> [25/72]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code>exports.inherits = <span class="kwrd">function</span>(newClass, baseClass) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(baseClass).<span class="func">forEach</span>(<span class="kwrd">function</span>(classMethod) <span class="gly">{</span></code></li><li class="covered"><code>        newClass<span class="gly">[</span>classMethod<span class="gly">]</span> = baseClass<span class="gly">[</span>classMethod<span class="gly">]</span>;</code><span class="hits">11</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    Object.<span class="func">keys</span>(baseClass.<span class="kwrd">prototype</span>).<span class="func">forEach</span>(<span class="kwrd">function</span>(instanceMethod) <span class="gly">{</span></code></li><li class="covered"><code>        newClass.<span class="kwrd">prototype</span><span class="gly">[</span>instanceMethod<span class="gly">]</span> = baseClass.<span class="kwrd">prototype</span><span class="gly">[</span>instanceMethod<span class="gly">]</span>;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.safeRequire = <span class="kwrd">function</span> <span class="func">safeRequire</span>(module) <span class="gly">{</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(module);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> str = module;</code></li><li class=""><code>        <span class="kwrd">if</span>(module === <span class="S">'rethinkdb'</span>) <span class="gly">{</span> str = module + <span class="S">' generic-pool moment'</span>; <span class="gly">}</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'Run "npm install '</span> + str + <span class="S">'" command to using '</span> + module + <span class="S">' database engine'</span>);</code></li><li class="uncovered"><code>        process.<span class="func">exit</span>(1);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.getState = <span class="kwrd">function</span> <span class="func">getState</span>(orm) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">switch</span> (orm.name) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'mysql'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'mariadb'</span>:</code></li><li class=""><code>            <span class="kwrd">if</span> (orm.client) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (orm.client._protocol) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (orm.client._protocol._fatalError) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (orm.client._protocol._fatalError.fatal) <span class="gly">{</span></code></li><li class="uncovered"><code>                            console.<span class="func">log</span>(<span class="S">'Connection ERROR:'</span>);</code></li><li class="uncovered"><code>                            console.<span class="func">log</span>(orm.client._protocol._fatalError);</code></li><li class="uncovered"><code>                            process.<span class="func">exit</span>(1);</code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> true;</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.helpers = <span class="gly">{</span></code></li><li class=""><code>    __slice: <span class="gly">[</span><span class="gly">]</span>.slice,</code></li><li class=""><code>    __bind: <span class="kwrd">function</span>(fn, me) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">return</span> <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> fn.<span class="func">apply</span>(me, arguments);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    merge: <span class="kwrd">function</span>(base, update) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> k, v;</code><span class="hits">3</span></li><li class=""><code>        <span class="kwrd">if</span> (!base) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> update;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">for</span> (k <span class="kwrd">in</span> update) <span class="gly">{</span></code></li><li class="covered"><code>            v = update<span class="gly">[</span>k<span class="gly">]</span>;</code><span class="hits">4</span></li><li class="covered"><code>            base<span class="gly">[</span>k<span class="gly">]</span> = update<span class="gly">[</span>k<span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> base;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    reverse: <span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> hasOrder = key.<span class="func">match</span>(/\s+(A<span class="gly">|</span>DE)SC$/i);</code></li><li class=""><code>        <span class="kwrd">if</span> (hasOrder) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (hasOrder<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">"DE"</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> -1;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> 1;</code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    inArray: <span class="kwrd">function</span>(p_val, arr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0, l = arr.length; i &lt; l; i++) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (arr<span class="gly">[</span>i<span class="gly">]</span> === p_val) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> true;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> false;</code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    stripOrder: <span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> key.<span class="func">replace</span>(/\s+(A<span class="gly">|</span>DE)SC/i, <span class="S">""</span>);</code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    savePrep: <span class="kwrd">function</span>(data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> id = data.id;</code></li><li class=""><code>        <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="uncovered"><code>            data._id = id.<span class="func">toString</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        delete data.id;</code></li><li class=""><code>        <span class="kwrd">if</span> (data._rev === null) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> delete data._rev;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    applyFilter: <span class="kwrd">function</span>(filter) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> self = this;</code><span class="hits">8</span></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.where === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> filter.where;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> keys = Object.<span class="func">keys</span>(filter.where);</code><span class="hits">8</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="kwrd">function</span>(obj) <span class="gly">{</span></code><span class="hits">8</span></li><li class="covered"><code>            <span class="kwrd">var</span> pass = true;</code><span class="hits">10</span></li><li class=""><code>            keys.<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.where<span class="gly">[</span>key<span class="gly">]</span> === <span class="S">'object'</span> &amp;&amp; !filter.where<span class="gly">[</span>key<span class="gly">]</span>.getTime) <span class="gly">{</span></code></li><li class="uncovered"><code>                    pass = self.<span class="func">parseCond</span>(obj<span class="gly">[</span>key<span class="gly">]</span>, filter.where<span class="gly">[</span>key<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (!self.<span class="func">testString</span>(filter.where<span class="gly">[</span>key<span class="gly">]</span>, obj<span class="gly">[</span>key<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>                        pass = false;</code><span class="hits">6</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">10</span></li><li class="covered"><code>            <span class="kwrd">return</span> pass;</code><span class="hits">10</span></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    testString: <span class="kwrd">function</span>(example, value) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'string'</span> &amp;&amp; example &amp;&amp; example.constructor.name === <span class="S">'RegExp'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> value.<span class="func">match</span>(example);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// not strict equality</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> (example !== null ? example.<span class="func">toString</span>() : example) === (value !== null ? value.<span class="func">toString</span>() : value);</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    parseCond: <span class="kwrd">function</span>(val, conds) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> outs = false;</code></li><li class=""><code>        Object.<span class="func">keys</span>(conds).<span class="func">forEach</span>(<span class="kwrd">function</span>(condType) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">switch</span> (condType) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'gt'</span>:</code></li><li class="uncovered"><code>                    outs = val &gt; conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'gte'</span>:</code></li><li class="uncovered"><code>                    outs = val &gt;= conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'lt'</span>:</code></li><li class="uncovered"><code>                    outs = val &lt; conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'lte'</span>:</code></li><li class="uncovered"><code>                    outs = val &lt;= conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'between'</span>:</code></li><li class=""><code>                    <span class="C">// need</span></code></li><li class="uncovered"><code>                    outs = val !== conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'inq'</span>:</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'in'</span>:</code></li><li class=""><code>                    conds<span class="gly">[</span>condType<span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(cval) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (val === cval) <span class="gly">{</span></code></li><li class="uncovered"><code>                            outs = true;</code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'nin'</span>:</code></li><li class=""><code>                    conds<span class="gly">[</span>condType<span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(cval) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (val === cval) <span class="gly">{</span></code></li><li class="uncovered"><code>                            outs = false;</code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'neq'</span>:</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'ne'</span>:</code></li><li class="uncovered"><code>                    outs = val !== conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'regex'</span>:</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'like'</span>:</code></li><li class="uncovered"><code>                    outs = <span class="kwrd">new</span> <span class="func">RegExp</span>(conds<span class="gly">[</span>condType<span class="gly">]</span>).<span class="func">test</span>(val);</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'nlike'</span>:</code></li><li class="uncovered"><code>                    outs = !<span class="kwrd">new</span> <span class="func">RegExp</span>(conds<span class="gly">[</span>condType<span class="gly">]</span>).<span class="func">test</span>(val);</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                default:</code></li><li class="uncovered"><code>                    outs = val === conds<span class="gly">[</span>condType<span class="gly">]</span> ? true : false;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> outs;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li></ol></pre></div></div>
<div id="lib-list-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-list-js" class="filename trigger" name="lib-list-js">lib/list.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 22%"><strong>22%</strong> [13/59]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code></code></li><li class="covered"><code>module.exports = List;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">List</span>(data, type, parent) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> list = this;</code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(list, <span class="S">'parent'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: false,</code></li><li class=""><code>        value: parent</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(list, <span class="S">'nextid'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: true,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        value: 1</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>    data = list.items = data <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> Item = list.ItemType = ListItem;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> type === <span class="S">'object'</span> &amp;&amp; type.constructor.name === <span class="S">'Array'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        list.ItemType = type<span class="gly">[</span>0<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> ListItem;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    data.<span class="func">forEach</span>(<span class="kwrd">function</span> (item, i) <span class="gly">{</span></code></li><li class="uncovered"><code>        data<span class="gly">[</span>i<span class="gly">]</span> = <span class="kwrd">new</span> <span class="func">Item</span>(item, list);</code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(list, data<span class="gly">[</span>i<span class="gly">]</span>.id, <span class="gly">{</span></code></li><li class=""><code>            writable: true,</code></li><li class=""><code>            enumerable: false,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            value:  data<span class="gly">[</span>i<span class="gly">]</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>        <span class="kwrd">if</span> (list.nextid &lt;= data<span class="gly">[</span>i<span class="gly">]</span>.id) <span class="gly">{</span></code></li><li class="uncovered"><code>            list.nextid = data<span class="gly">[</span>i<span class="gly">]</span>.id + 1;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(list, <span class="S">'length'</span>, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> list.items.length;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> list;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">var</span> _;</code><span class="hits">1</span></li><li class=""><code>try <span class="gly">{</span></code></li><li class="uncovered"><code>    _ = <span class="func">require</span>(<span class="S">'underscore'</span>);</code></li><li class=""><code><span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="covered"><code>    _ = false;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">if</span> (_) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> _import = <span class="gly">[</span></code></li><li class=""><code>    <span class="C">// collection methods</span></code></li><li class=""><code>    <span class="S">'each'</span>,</code></li><li class=""><code>    <span class="S">'map'</span>,</code></li><li class=""><code>    <span class="S">'reduce'</span>,</code></li><li class=""><code>    <span class="S">'reduceRight'</span>,</code></li><li class=""><code>    <span class="S">'find'</span>,</code></li><li class=""><code>    <span class="S">'filter'</span>,</code></li><li class=""><code>    <span class="S">'reject'</span>,</code></li><li class=""><code>    <span class="S">'all'</span>,</code></li><li class=""><code>    <span class="S">'any'</span>,</code></li><li class=""><code>    <span class="S">'include'</span>,</code></li><li class=""><code>    <span class="S">'invoke'</span>,</code></li><li class=""><code>    <span class="S">'pluck'</span>,</code></li><li class=""><code>    <span class="S">'max'</span>,</code></li><li class=""><code>    <span class="S">'min'</span>,</code></li><li class=""><code>    <span class="S">'sortBy'</span>,</code></li><li class=""><code>    <span class="S">'groupBy'</span>,</code></li><li class=""><code>    <span class="S">'sortedIndex'</span>,</code></li><li class=""><code>    <span class="S">'shuffle'</span>,</code></li><li class=""><code>    <span class="S">'toArray'</span>,</code></li><li class=""><code>    <span class="S">'size'</span>,</code></li><li class=""><code>    <span class="C">// array methods</span></code></li><li class=""><code>    <span class="S">'first'</span>,</code></li><li class=""><code>    <span class="S">'initial'</span>,</code></li><li class=""><code>    <span class="S">'last'</span>,</code></li><li class=""><code>    <span class="S">'rest'</span>,</code></li><li class=""><code>    <span class="S">'compact'</span>,</code></li><li class=""><code>    <span class="S">'flatten'</span>,</code></li><li class=""><code>    <span class="S">'without'</span>,</code></li><li class=""><code>    <span class="S">'union'</span>,</code></li><li class=""><code>    <span class="S">'intersection'</span>,</code></li><li class=""><code>    <span class="S">'difference'</span>,</code></li><li class=""><code>    <span class="S">'uniq'</span>,</code></li><li class=""><code>    <span class="S">'zip'</span>,</code></li><li class=""><code>    <span class="S">'indexOf'</span>,</code></li><li class=""><code>    <span class="S">'lastIndexOf'</span>,</code></li><li class=""><code>    <span class="S">'range'</span></code></li><li class="uncovered"><code>    <span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>    _import.<span class="func">forEach</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>        List.<span class="kwrd">prototype</span><span class="gly">[</span>name<span class="gly">]</span> = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> args = <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(arguments);</code></li><li class="uncovered"><code>            args.<span class="func">unshift</span>(this.items);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> _<span class="gly">[</span>name<span class="gly">]</span>.<span class="func">apply</span>(_, args);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.toObject = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.items;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.toJSON = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.items;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.toString = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> JSON.<span class="func">stringify</span>(this.items);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.autoincrement = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.nextid++;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.push = <span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> item = <span class="kwrd">new</span> <span class="func">ListItem</span>(obj, this);</code></li><li class="uncovered"><code>    this.items.<span class="func">push</span>(item);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> item;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.remove = <span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> id = obj.id ? obj.id : obj;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> found = false;</code></li><li class=""><code>    this.items.<span class="func">forEach</span>(<span class="kwrd">function</span> (o, i) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (id &amp;&amp; o.id === id) <span class="gly">{</span></code></li><li class="uncovered"><code>            found = i;</code></li><li class=""><code>            <span class="kwrd">if</span> (o.id !== id) <span class="gly">{</span></code></li><li class="uncovered"><code>                console.<span class="func">log</span>(<span class="S">'WARNING! Type of id not matched'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="kwrd">if</span> (found !== false) <span class="gly">{</span></code></li><li class="uncovered"><code>        delete this<span class="gly">[</span>id<span class="gly">]</span>;</code></li><li class="uncovered"><code>        this.items.<span class="func">splice</span>(found, 1);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.forEach = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.items.<span class="func">forEach</span>(cb);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.sort = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.items.<span class="func">sort</span>(cb);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>List.<span class="kwrd">prototype</span>.map = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> cb === <span class="S">'function'</span>) <span class="kwrd">return</span> this.items.<span class="func">map</span>(cb);</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> cb === <span class="S">'string'</span>) <span class="kwrd">return</span> this.items.<span class="func">map</span>(<span class="kwrd">function</span> (el) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> el<span class="gly">[</span>cb<span class="gly">]</span> === <span class="S">'function'</span>) <span class="kwrd">return</span> el<span class="gly">[</span>cb<span class="gly">]</span>();</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (el.<span class="func">hasOwnProperty</span>(cb)) <span class="kwrd">return</span> el<span class="gly">[</span>cb<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">ListItem</span>(data, parent) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> data) this<span class="gly">[</span>i<span class="gly">]</span> = data<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'parent'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: parent</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="kwrd">if</span> (!this.id) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.id = parent.<span class="func">autoincrement</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (parent.ItemType) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.__proto__ = parent.ItemType.<span class="kwrd">prototype</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (parent.ItemType !== ListItem) <span class="gly">{</span></code></li><li class="uncovered"><code>            parent.ItemType.<span class="func">apply</span>(this);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.save = <span class="kwrd">function</span> (c) <span class="gly">{</span></code></li><li class="uncovered"><code>        parent.parent.<span class="func">save</span>(c);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code><span class="gly">}</span></code></li></ol></pre></div></div>
<div id="lib-hookable-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-hookable-js" class="filename trigger" name="lib-hookable-js">lib/hookable.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 100%"><strong>100%</strong> [25/25]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code>exports.Hookable = Hookable;</code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Hookable</span>() <span class="gly">{</span></code></li><li class=""><code><span class="C">// hookable class</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>Hookable.afterInitialize = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeValidation = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterValidation = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeSave = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterSave = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeCreate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterCreate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeUpdate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterUpdate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeDestroy = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterDestroy = null;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Hookable.<span class="kwrd">prototype</span>.trigger = <span class="kwrd">function</span> <span class="func">trigger</span>(actionName, work, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> capitalizedName = <span class="func">capitalize</span>(actionName);</code><span class="hits">69</span></li><li class="covered"><code>    <span class="kwrd">var</span> afterHook = this.constructor<span class="gly">[</span><span class="S">"after"</span> + capitalizedName<span class="gly">]</span>;</code><span class="hits">69</span></li><li class="covered"><code>    <span class="kwrd">var</span> beforeHook = this.constructor<span class="gly">[</span><span class="S">"before"</span> + capitalizedName<span class="gly">]</span>;</code><span class="hits">69</span></li><li class="covered"><code>    <span class="kwrd">var</span> inst = this;</code><span class="hits">69</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// we only call "before" hook when we have actual action (work) to perform</span></code></li><li class=""><code>    <span class="kwrd">if</span> (work) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (beforeHook) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// before hook should be called on instance with one param: callback</span></code></li><li class=""><code>            beforeHook.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// actual action also have one param: callback</span></code></li><li class="covered"><code>                work.<span class="func">call</span>(inst, next);</code><span class="hits">1</span></li><li class="covered"><code>            <span class="gly">}</span>, data);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            work.<span class="func">call</span>(inst, next);</code><span class="hits">39</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">next</span>();</code><span class="hits">26</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">next</span>(done) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (afterHook) <span class="gly">{</span></code></li><li class="covered"><code>            afterHook.<span class="func">call</span>(inst, done);</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (done) <span class="gly">{</span></code></li><li class="covered"><code>            done.<span class="func">call</span>(this);</code><span class="hits">24</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">capitalize</span>(string) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> string.<span class="func">charAt</span>(0).toUpper<span class="kwrd">Case</span>() + string.<span class="func">slice</span>(1);</code><span class="hits">69</span></li><li class=""><code><span class="gly">}</span></code></li></ol></pre></div></div>
<div class="group-header row" id="lib-adapters"><div class="group-name span5">./lib/adapters</div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 48%"><strong>48%</strong> [219/460]</div></div></div></div><div id="lib-adapters-mysql-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-adapters-mysql-js" class="filename trigger" name="lib-adapters-mysql-js">lib/adapters/mysql.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 47%"><strong>47%</strong> [171/367]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> mysql = <span class="func">safeRequire</span>(<span class="S">'mysql'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> BaseSQL = <span class="func">require</span>(<span class="S">'../sql'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!mysql) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> s = schema.settings;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">var</span> conSettings = <span class="gly">{</span></code></li><li class=""><code>        host: s.host <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>,</code></li><li class=""><code>        port: s.port <span class="gly">|</span><span class="gly">|</span> 3306,</code></li><li class=""><code>        user: s.username,</code></li><li class=""><code>        password: s.password,</code></li><li class=""><code>        debug: s.debug</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> dbName = s.database;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (s.pool) <span class="gly">{</span></code></li><li class="uncovered"><code>        schema.client = mysql.<span class="func">createPool</span>(conSettings);</code></li><li class=""><code>        schema.client.<span class="func">getConnection</span>(<span class="kwrd">function</span>(err, connection) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                throw <span class="kwrd">new</span> <span class="func">Error</span>(err);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>        schema.adapter = <span class="kwrd">new</span> <span class="func">MySQL</span>(schema.client, conSettings);</code></li><li class="uncovered"><code>        schema.adapter.schema = schema;</code></li><li class=""><code>        schema.client.<span class="func">once</span>(<span class="S">'connection'</span>, <span class="kwrd">function</span>(connection) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">startAdapter</span>(schema, dbName, callback);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        schema.client = mysql.<span class="func">createConnection</span>(conSettings);</code><span class="hits">1</span></li><li class="covered"><code>        schema.adapter = <span class="kwrd">new</span> <span class="func">MySQL</span>(schema.client, conSettings);</code><span class="hits">1</span></li><li class="covered"><code>        schema.adapter.schema = schema;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">startAdapter</span>(schema, dbName, callback);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">handleDisconnect</span>(client) <span class="gly">{</span></code></li><li class=""><code>        schema.client.<span class="func">on</span>(<span class="S">'error'</span>, <span class="kwrd">function</span> (error) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span>(error.code !== <span class="S">'PROTOCOL_CONNECTION_LOST'</span>) throw error;</code></li><li class=""><code></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">"&gt; Re-connecting lost MySQL connection: "</span> + error.stack);</code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span> (s.pool) <span class="gly">{</span></code></li><li class="uncovered"><code>                schema.client = mysql.<span class="func">createPool</span>(conSettings);</code></li><li class=""><code>                schema.client.<span class="func">getConnection</span>(<span class="kwrd">function</span> (err, connection) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                        throw <span class="kwrd">new</span> <span class="func">Error</span>(err);</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>                schema.adapter = <span class="kwrd">new</span> <span class="func">MySQL</span>(schema.client, conSettings);</code></li><li class="uncovered"><code>                schema.adapter.schema = schema;</code></li><li class=""><code>                schema.client.<span class="func">once</span>(<span class="S">'connection'</span>, <span class="kwrd">function</span> (connection) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">startAdapter</span>(schema, dbName, callback);</code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>                <span class="func">handleDisconnect</span>(schema.client);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                schema.client = mysql.<span class="func">createConnection</span>(conSettings);</code></li><li class="uncovered"><code>                schema.adapter = <span class="kwrd">new</span> <span class="func">MySQL</span>(schema.client, conSettings);</code></li><li class="uncovered"><code>                schema.adapter.schema = schema;</code></li><li class="uncovered"><code>                <span class="func">startAdapter</span>(schema, dbName, callback);</code></li><li class="uncovered"><code>                <span class="func">handleDisconnect</span>(schema.client);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="func">handleDisconnect</span>(schema.client);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">startAdapter</span>(schema, dbName, callback) <span class="gly">{</span></code></li><li class=""><code>    schema.client.<span class="func">query</span>(<span class="S">'USE `'</span> + dbName + <span class="S">'`'</span>, <span class="kwrd">function</span>(err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err &amp;&amp; err.message.<span class="func">match</span>(/unknown database/i)) <span class="gly">{</span></code></li><li class=""><code>            schema.client.<span class="func">query</span>(<span class="S">'CREATE DATABASE '</span> + dbName, <span class="kwrd">function</span>(error) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!error) <span class="gly">{</span></code></li><li class="uncovered"><code>                    schema.client.<span class="func">query</span>(<span class="S">'USE '</span> + dbName, callback);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    throw error;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * MySQL adapter</span></code></li><li class=""><code><span class="C"> * @param {Object} client</span></code></li><li class=""><code><span class="C"> * @param {Object} conSettings</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">MySQL</span>(client, conSettings) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    this.log = console.log;</code><span class="hits">1</span></li><li class="covered"><code>    this.client = client;</code><span class="hits">1</span></li><li class="covered"><code>    this.settings = conSettings;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="func">require</span>(<span class="S">'util'</span>).<span class="func">inherits</span>(MySQL, BaseSQL);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.query = <span class="kwrd">function</span>(sql, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">77</span></li><li class="covered"><code>    <span class="kwrd">var</span> client = self.client;</code><span class="hits">77</span></li><li class="covered"><code>    <span class="kwrd">var</span> log = self.log <span class="gly">|</span><span class="gly">|</span> console.log;</code><span class="hits">77</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback !== <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'callback should be a function'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    </code></li><li class=""><code>    client.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (log) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// log(new Date().toISOString(), '###', sql, err);</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err &amp;&amp; err.message.<span class="func">match</span>(/unknown database/i)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> dbName = err.message.<span class="func">match</span>(/unknown database <span class="S">'(.*?)'</span>/i)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>            client.<span class="func">query</span>(<span class="S">'CREATE DATABASE '</span> + dbName, <span class="kwrd">function</span>(error) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!error) <span class="gly">{</span></code></li><li class="uncovered"><code>                    client.<span class="func">query</span>(sql, callback);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">callback</span>(err);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (err &amp;&amp; (err.message.<span class="func">match</span>(/No\s+database\s+selected/gi) <span class="gly">|</span><span class="gly">|</span> <span class="func">parseInt</span>(err.errno) === 1046)) <span class="gly">{</span></code></li><li class=""><code>            client.<span class="func">query</span>(<span class="S">'USE `'</span> + self.schema.settings.database + <span class="S">'`'</span>, <span class="kwrd">function</span>(error) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!error) <span class="gly">{</span></code></li><li class="uncovered"><code>                    client.<span class="func">query</span>(sql, callback);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">callback</span>(error);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, data);</code><span class="hits">77</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">77</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Start transaction callback(err, id)</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.beg<span class="kwrd">in</span> = <span class="kwrd">function</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> params) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = null;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    this.<span class="func">query</span>(<span class="S">'START TRANSACTION'</span>, callback);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Commit transaction callback(err, id)</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.commit = <span class="kwrd">function</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> params) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = null;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    this.<span class="func">query</span>(<span class="S">'COMMIT'</span>, callback);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Rollback transaction callback(err, id)</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.rollback = <span class="kwrd">function</span>(params, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> params) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = params;</code></li><li class="uncovered"><code>        params = null;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    this.<span class="func">query</span>(<span class="S">'ROLLBACK'</span>, callback);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Create multi column index callback(err, id)</span></code></li><li class=""><code><span class="C"> * @param {Object} model</span></code></li><li class=""><code><span class="C"> * @param {Object} fields</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.ensureIndex = <span class="kwrd">function</span>(model, fields, params, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this, sql = <span class="S">""</span>, keyName = params.name <span class="gly">|</span><span class="gly">|</span> null, afld = <span class="gly">[</span><span class="gly">]</span>, kind = <span class="S">""</span>;</code></li><li class=""><code>    Object.<span class="func">keys</span>(fields).<span class="func">forEach</span>(<span class="kwrd">function</span>(field) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!keyName) <span class="gly">{</span></code></li><li class="uncovered"><code>            keyName = <span class="S">"idx_"</span> + field;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        afld.<span class="func">push</span>(<span class="S">'`'</span> + field + <span class="S">'`'</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="kwrd">if</span> (params.unique) <span class="gly">{</span></code></li><li class="uncovered"><code>        kind = <span class="S">"UNIQUE"</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="C">// sql = 'USE `' + self.schema.settings.database + '`; ';</span></code></li><li class="uncovered"><code>    sql += <span class="S">'ALTER TABLE `'</span> + model + <span class="S">'` ADD '</span> + kind + <span class="S">' INDEX `'</span> + keyName + <span class="S">'` ('</span> + afld.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">');'</span>;</code></li><li class="uncovered"><code>    self.<span class="func">query</span>(sql, callback);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Must invoke callback(err, id)</span></code></li><li class=""><code><span class="C"> * @param {Object} model</span></code></li><li class=""><code><span class="C"> * @param {Object} data</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.create = <span class="kwrd">function</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fields = this.<span class="func">toFields</span>(model, data);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (fields) <span class="gly">{</span></code></li><li class="covered"><code>        sql += <span class="S">' SET '</span> + fields;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        sql += <span class="S">' VALUES ()'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, info) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, info &amp;&amp; info.insertId);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.updateOrCreate = <span class="kwrd">function</span>(model, data, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> mysql = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> fieldsNames = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> fieldValues = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> combined = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> key === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> k = <span class="S">'`'</span> + key + <span class="S">'`'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> v;</code></li><li class=""><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                v = mysql.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                v = data<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            fieldsNames.<span class="func">push</span>(k);</code></li><li class="uncovered"><code>            fieldValues.<span class="func">push</span>(v);</code></li><li class=""><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>)</code></li><li class="uncovered"><code>                combined.<span class="func">push</span>(k + <span class="S">' = '</span> + v);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model);</code></li><li class="uncovered"><code>    sql += <span class="S">' ('</span> + fieldsNames.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code></li><li class="uncovered"><code>    sql += <span class="S">' VALUES ('</span> + fieldValues.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code></li><li class="uncovered"><code>    sql += <span class="S">' ON DUPLICATE KEY UPDATE '</span> + combined.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, info) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!err &amp;&amp; info &amp;&amp; info.insertId) <span class="gly">{</span></code></li><li class="uncovered"><code>            data.id = info.insertId;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err, data);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update rows</span></code></li><li class=""><code><span class="C"> * @param {String} model</span></code></li><li class=""><code><span class="C"> * @param {Object} filter</span></code></li><li class=""><code><span class="C"> * @param {Object} data</span></code></li><li class=""><code><span class="C"> * @param {Function} callback</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.update = <span class="kwrd">function</span>(model, filter, data, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> filter) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">filter</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">"Get parametrs undefined"</span>), null);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">data</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">"Set parametrs undefined"</span>), null);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    filter = filter.where ? filter.where : filter;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> combined = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> props = self._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> key === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> k = <span class="S">'`'</span> + key + <span class="S">'`'</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> v;</code></li><li class=""><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                v = self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                v = data<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            combined.<span class="func">push</span>(k + <span class="S">' = '</span> + v);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> sql = <span class="S">'UPDATE '</span> + this.<span class="func">tableEscaped</span>(model);</code></li><li class="uncovered"><code>    sql += <span class="S">' SET '</span> + combined.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code></li><li class="uncovered"><code>    sql += <span class="S">' '</span> + self.<span class="func">buildWhere</span>(filter, self, model);</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, affected) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(err, ((affected <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).affectedRows <span class="gly">|</span><span class="gly">|</span> affected));</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.toFields = <span class="kwrd">function</span>(model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fields = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">1</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            fields.<span class="func">push</span>(<span class="S">'`'</span> + key.<span class="func">replace</span>(/\./g, <span class="S">'`.`'</span>) + <span class="S">'` = '</span> + this.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">return</span> fields.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">dateToMysql</span>(val) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">return</span> val.<span class="func">getUTCFullYear</span>() + <span class="S">'-'</span> +</code></li><li class=""><code>            <span class="func">fillZeros</span>(val.<span class="func">getUTCMonth</span>() + 1) + <span class="S">'-'</span> +</code></li><li class=""><code>            <span class="func">fillZeros</span>(val.<span class="func">getUTCDate</span>()) + <span class="S">' '</span> +</code></li><li class=""><code>            <span class="func">fillZeros</span>(val.<span class="func">getUTCHours</span>()) + <span class="S">':'</span> +</code></li><li class=""><code>            <span class="func">fillZeros</span>(val.<span class="func">getUTCMinutes</span>()) + <span class="S">':'</span> +</code></li><li class="uncovered"><code>            <span class="func">fillZeros</span>(val.<span class="func">getUTCSeconds</span>());</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">fillZeros</span>(v) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> v &lt; 10 ? <span class="S">'0'</span> + v : v;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.toDatabase = <span class="kwrd">function</span>(prop, val) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (val === null) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (val.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> operator = Object.<span class="func">keys</span>(val)<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class="uncovered"><code>        val = val<span class="gly">[</span>operator<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (operator === <span class="S">'between'</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (prop.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">return</span>  <span class="S">'STR_TO_DATE('</span> + this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>0<span class="gly">]</span>) + <span class="S">', "%Y-%m-%d %H:%i:%s")'</span> +</code></li><li class=""><code>                        <span class="S">' AND STR_TO_DATE('</span> +</code></li><li class="uncovered"><code>                        this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>1<span class="gly">]</span>) + <span class="S">', "%Y-%m-%d %H:%i:%s")'</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">return</span>  this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>0<span class="gly">]</span>) +</code></li><li class=""><code>                        <span class="S">' AND '</span> +</code></li><li class="uncovered"><code>                        this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>1<span class="gly">]</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (operator === <span class="S">'in'</span> <span class="gly">|</span><span class="gly">|</span> operator === <span class="S">'inq'</span> <span class="gly">|</span><span class="gly">|</span> operator === <span class="S">'nin'</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!(val.<span class="func">propertyIsEnumerable</span>(<span class="S">'length'</span>)) &amp;&amp; <span class="kwrd">typeof</span> val === <span class="S">'object'</span> &amp;&amp; <span class="kwrd">typeof</span> val.length === <span class="S">'number'</span>) <span class="gly">{</span> <span class="C">//if value is array</span></code></li><li class=""><code>                <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i &lt; val.length; i++) <span class="gly">{</span></code></li><li class="uncovered"><code>                    val<span class="gly">[</span>i<span class="gly">]</span> = this.client.<span class="func">escape</span>(val<span class="gly">[</span>i<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> val.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> val;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!prop) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> val;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Number'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> val;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!val)</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (!val.toUTCString) <span class="gly">{</span></code></li><li class="uncovered"><code>            val = <span class="kwrd">new</span> <span class="func">Date</span>(val);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="S">'"'</span> + <span class="func">dateToMysql</span>(val) + <span class="S">'"'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">"Boolean"</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> val ? 1 : 0;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.client.<span class="func">escape</span>(val.<span class="func">toString</span>());</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.fromDatabase = <span class="kwrd">function</span>(model, data) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!data)</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> null;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> val = data<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.type.name === <span class="S">'Date'</span> &amp;&amp; val !== null) <span class="gly">{</span></code></li><li class="uncovered"><code>                val = <span class="kwrd">new</span> <span class="func">Date</span>(val.<span class="func">toString</span>().<span class="func">replace</span>(/GMT.*$/, <span class="S">'GMT'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        data<span class="gly">[</span>key<span class="gly">]</span> = val;</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> data;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.escapeName = <span class="kwrd">function</span>(name) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'`'</span> + name.<span class="func">replace</span>(/\./g, <span class="S">'`.`'</span>) + <span class="S">'`'</span>;</code><span class="hits">51</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this, sFields = <span class="S">'*'</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> filter) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = filter;</code></li><li class="uncovered"><code>        filter = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!filter) <span class="gly">{</span></code></li><li class="uncovered"><code>        filter = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT '</span> + sFields + <span class="S">' FROM '</span> + self.<span class="func">tableEscaped</span>(model);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.fields) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.fields === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                sFields = self.<span class="func">tableEscaped</span>(filter.fields);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (Object.<span class="kwrd">prototype</span>.toString.<span class="func">call</span>(filter.fields) === <span class="S">'[object Array]'</span>) <span class="gly">{</span></code></li><li class=""><code>               sFields = filter.fields.<span class="func">map</span>(<span class="kwrd">function</span>(field) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="S">'`'</span> + field + <span class="S">'`'</span>;</code></li><li class="uncovered"><code>               <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            sql = sql.<span class="func">replace</span>(<span class="S">'*'</span>, sFields);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql += <span class="S">' '</span> + self.<span class="func">buildWhere</span>(filter.where, self, model);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql += <span class="S">' '</span> + self.<span class="func">buildOrderBy</span>(filter.order);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.group) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql += <span class="S">' '</span> + self.<span class="func">buildGroupBy</span>(filter.group);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql += <span class="S">' '</span> + self.<span class="func">buildLimit</span>(filter.limit, filter.offset <span class="gly">|</span><span class="gly">|</span> filter.skip <span class="gly">|</span><span class="gly">|</span> 0);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span>(err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="func">callback</span>(null, data.<span class="func">map</span>(<span class="kwrd">function</span>(obj) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> self.<span class="func">fromDatabase</span>(model, obj);</code></li><li class="uncovered"><code>        <span class="gly">}</span>));</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> sql;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.autoupdate = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">10</span></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 0;</code><span class="hits">10</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span>(model) <span class="gly">{</span></code></li><li class="covered"><code>        wait += 1;</code><span class="hits">20</span></li><li class=""><code>        self.<span class="func">query</span>(<span class="S">'SHOW FIELDS FROM '</span> + self.<span class="func">tableEscaped</span>(model), <span class="kwrd">function</span>(err, fields) <span class="gly">{</span></code></li><li class=""><code>            self.<span class="func">query</span>(<span class="S">'SHOW INDEXES FROM '</span> + self.<span class="func">tableEscaped</span>(model), <span class="kwrd">function</span>(err, indexes) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!err &amp;&amp; fields.length) <span class="gly">{</span></code></li><li class="covered"><code>                    self.<span class="func">alterTable</span>(model, fields, indexes, done);</code><span class="hits">18</span></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    self.<span class="func">createTable</span>(model, indexes, done);</code><span class="hits">2</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">20</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">20</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">10</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 &amp;&amp; cb) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>();</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.isActual = <span class="kwrd">function</span>(cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ok = false;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 0;</code><span class="hits">4</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span>(model) <span class="gly">{</span></code></li><li class="covered"><code>        wait += 1;</code><span class="hits">8</span></li><li class=""><code>        self.<span class="func">query</span>(<span class="S">'SHOW FIELDS FROM '</span> + model, <span class="kwrd">function</span>(err, fields) <span class="gly">{</span></code></li><li class=""><code>            self.<span class="func">query</span>(<span class="S">'SHOW INDEXES FROM '</span> + model, <span class="kwrd">function</span>(err, indexes) <span class="gly">{</span></code></li><li class="covered"><code>                self.<span class="func">alterTable</span>(model, fields, indexes, done, true);</code><span class="hits">8</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">8</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">8</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err, needAlter) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        ok = ok <span class="gly">|</span><span class="gly">|</span> needAlter;</code><span class="hits">8</span></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 &amp;&amp; cb) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>(null, !ok);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.alterTable = <span class="kwrd">function</span>(model, actualFields, actualIndexes, done, checkOnly) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="kwrd">var</span> m = this._models<span class="gly">[</span>model<span class="gly">]</span>;</code><span class="hits">26</span></li><li class=""><code>    <span class="kwrd">var</span> propNames = Object.<span class="func">keys</span>(m.properties).<span class="func">filter</span>(<span class="kwrd">function</span>(name) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> !!m.properties<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">155</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code>    <span class="kwrd">var</span> indexNames = m.settings.indexes ? Object.<span class="func">keys</span>(m.settings.indexes).<span class="func">filter</span>(<span class="kwrd">function</span>(name) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> !!m.settings.indexes<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="gly">}</span>) : <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">26</span></li><li class="covered"><code>    <span class="kwrd">var</span> ai = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">26</span></li><li class=""><code>    <span class="kwrd">if</span> (actualIndexes) <span class="gly">{</span></code></li><li class=""><code>        actualIndexes.<span class="func">forEach</span>(<span class="kwrd">function</span>(i) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> name = i.Key_name;</code><span class="hits">81</span></li><li class=""><code>            <span class="kwrd">if</span> (!ai<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                ai<span class="gly">[</span>name<span class="gly">]</span> = <span class="gly">{</span></code></li><li class=""><code>                    info: i,</code></li><li class=""><code>                    columns: <span class="gly">[</span><span class="gly">]</span></code></li><li class="covered"><code>                <span class="gly">}</span>;</code><span class="hits">69</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            ai<span class="gly">[</span>name<span class="gly">]</span>.columns<span class="gly">[</span>i.Seq_in_index - 1<span class="gly">]</span> = i.Column_name;</code><span class="hits">81</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> aiNames = Object.<span class="func">keys</span>(ai);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// change/add new fields</span></code></li><li class=""><code>    propNames.<span class="func">forEach</span>(<span class="kwrd">function</span>(propName) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (propName === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">26</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> found;</code><span class="hits">116</span></li><li class=""><code>        actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span>(f) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (f.Field === propName) <span class="gly">{</span></code></li><li class="covered"><code>                found = f;</code><span class="hits">115</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">116</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (found) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">actualize</span>(propName, found);</code><span class="hits">115</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'ADD COLUMN `'</span> + propName + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// drop columns</span></code></li><li class=""><code>    actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span>(f) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> notFound = !~propNames.<span class="func">indexOf</span>(f.Field);</code><span class="hits">130</span></li><li class=""><code>        <span class="kwrd">if</span> (f.Field === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">13</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (notFound <span class="gly">|</span><span class="gly">|</span> !m.properties<span class="gly">[</span>f.Field<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'DROP COLUMN `'</span> + f.Field + <span class="S">'` '</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// remove indexes</span></code></li><li class=""><code>    aiNames.<span class="func">forEach</span>(<span class="kwrd">function</span>(indexName) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (indexName === <span class="S">'id'</span> <span class="gly">|</span><span class="gly">|</span> indexName === <span class="S">'PRIMARY'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">39</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (indexNames.<span class="func">indexOf</span>(indexName) === -1 &amp;&amp; !m.properties<span class="gly">[</span>indexName<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> m.properties<span class="gly">[</span>indexName<span class="gly">]</span> &amp;&amp; !m.properties<span class="gly">[</span>indexName<span class="gly">]</span>.index) <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'DROP INDEX `'</span> + indexName + <span class="S">'`'</span>);</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// first: check single (only type and kind)</span></code></li><li class=""><code>            <span class="kwrd">if</span> (m.properties<span class="gly">[</span>indexName<span class="gly">]</span> &amp;&amp; !m.properties<span class="gly">[</span>indexName<span class="gly">]</span>.index) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// TODO</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="C">// second: check multiple indexes</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> orderMatched = true;</code><span class="hits">27</span></li><li class=""><code>            <span class="kwrd">if</span> (indexNames.<span class="func">indexOf</span>(indexName) !== -1) <span class="gly">{</span></code></li><li class=""><code>                m.settings.indexes<span class="gly">[</span>indexName<span class="gly">]</span>.columns.<span class="func">split</span>(/,\s*/).<span class="func">forEach</span>(<span class="kwrd">function</span>(columnName, i) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (ai<span class="gly">[</span>indexName<span class="gly">]</span>.columns<span class="gly">[</span>i<span class="gly">]</span> !== columnName)</code></li><li class="covered"><code>                        orderMatched = false;</code><span class="hits">36</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">24</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!orderMatched) <span class="gly">{</span></code></li><li class="covered"><code>                sql.<span class="func">push</span>(<span class="S">'DROP INDEX `'</span> + indexName + <span class="S">'`'</span>);</code><span class="hits">2</span></li><li class="covered"><code>                delete ai<span class="gly">[</span>indexName<span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// add single-column indexes</span></code></li><li class=""><code>    propNames.<span class="func">forEach</span>(<span class="kwrd">function</span>(propName) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> i = m.properties<span class="gly">[</span>propName<span class="gly">]</span>.index;</code><span class="hits">142</span></li><li class=""><code>        <span class="kwrd">if</span> (!i) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">135</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> found = ai<span class="gly">[</span>propName<span class="gly">]</span> &amp;&amp; ai<span class="gly">[</span>propName<span class="gly">]</span>.info;</code><span class="hits">7</span></li><li class=""><code>        <span class="kwrd">if</span> (!found) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> type = <span class="S">''</span>;</code><span class="hits">4</span></li><li class="covered"><code>            <span class="kwrd">var</span> kind = <span class="S">''</span>;</code><span class="hits">4</span></li><li class=""><code>            <span class="kwrd">if</span> (i.type) <span class="gly">{</span></code></li><li class="covered"><code>                type = <span class="S">'USING '</span> + i.type;</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (i.kind) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// kind = i.kind;</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (kind &amp;&amp; type) <span class="gly">{</span></code></li><li class="uncovered"><code>                sql.<span class="func">push</span>(<span class="S">'ADD '</span> + kind + <span class="S">' INDEX `'</span> + propName + <span class="S">'` (`'</span> + propName + <span class="S">'`) '</span> + type);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                sql.<span class="func">push</span>(<span class="S">'ADD '</span> + kind + <span class="S">' INDEX `'</span> + propName + <span class="S">'` '</span> + type + <span class="S">' (`'</span> + propName + <span class="S">'`) '</span>);</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// add multi-column indexes</span></code></li><li class=""><code>    indexNames.<span class="func">forEach</span>(<span class="kwrd">function</span>(indexName) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> i = m.settings.indexes<span class="gly">[</span>indexName<span class="gly">]</span>;</code><span class="hits">26</span></li><li class="covered"><code>        <span class="kwrd">var</span> found = ai<span class="gly">[</span>indexName<span class="gly">]</span> &amp;&amp; ai<span class="gly">[</span>indexName<span class="gly">]</span>.info;</code><span class="hits">26</span></li><li class=""><code>        <span class="kwrd">if</span> (!found) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> type = <span class="S">''</span>;</code><span class="hits">4</span></li><li class="covered"><code>            <span class="kwrd">var</span> kind = <span class="S">''</span>;</code><span class="hits">4</span></li><li class=""><code>            <span class="kwrd">if</span> (i.type) <span class="gly">{</span></code></li><li class="uncovered"><code>                type = <span class="S">'USING '</span> + i.kind;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (i.kind) <span class="gly">{</span></code></li><li class="uncovered"><code>                kind = i.kind;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (kind &amp;&amp; type) <span class="gly">{</span></code></li><li class="uncovered"><code>                sql.<span class="func">push</span>(<span class="S">'ADD '</span> + kind + <span class="S">' INDEX `'</span> + indexName + <span class="S">'` ('</span> + i.columns + <span class="S">') '</span> + type);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                sql.<span class="func">push</span>(<span class="S">'ADD '</span> + kind + <span class="S">' INDEX '</span> + type + <span class="S">' `'</span> + indexName + <span class="S">'` ('</span> + i.columns + <span class="S">')'</span>);</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">26</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (sql.length) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> query = <span class="S">'ALTER TABLE '</span> + self.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span> + sql.jo<span class="kwrd">in</span>(<span class="S">',\n'</span>);</code><span class="hits">8</span></li><li class=""><code>        <span class="kwrd">if</span> (checkOnly) <span class="gly">{</span></code></li><li class=""><code>            <span class="func">done</span>(null, true, <span class="gly">{</span></code></li><li class=""><code>                statements: sql,</code></li><li class=""><code>                query: query</code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            this.<span class="func">query</span>(query, done);</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">done</span>();</code><span class="hits">18</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">actualize</span>(propName, oldSettings) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> newSettings = m.properties<span class="gly">[</span>propName<span class="gly">]</span>;</code><span class="hits">115</span></li><li class=""><code>        <span class="kwrd">if</span> (newSettings &amp;&amp; <span class="func">changed</span>(newSettings, oldSettings)) <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'CHANGE COLUMN `'</span> + propName + <span class="S">'` `'</span> + propName + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">changed</span>(newSettings, oldSettings) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'YES'</span> &amp;&amp; (newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> true;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'NO'</span> &amp;&amp; (<span class="func">getDefaultValue</span>(newSettings) !== <span class="func">getDefaultValue</span>(oldSettings))) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> true;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (oldSettings.Type.toUpper<span class="kwrd">Case</span>() !== <span class="func">datatype</span>(newSettings)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> true;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> false;</code><span class="hits">112</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.propertiesSQL = <span class="kwrd">function</span>(model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(this._models<span class="gly">[</span>model<span class="gly">]</span>.properties).<span class="func">forEach</span>(<span class="kwrd">function</span>(prop) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (prop === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> sql.<span class="func">push</span>(<span class="S">'`'</span> + prop + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, prop));</code><span class="hits">9</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> primaryKeys = this._models<span class="gly">[</span>model<span class="gly">]</span>.settings.primaryKeys <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    primaryKeys = primaryKeys.<span class="func">slice</span>(0);</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span>(primaryKeys.length) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">for</span>(<span class="kwrd">var</span> i = 0, length = primaryKeys.length; i &lt; length; i ++) <span class="gly">{</span></code></li><li class="covered"><code>            primaryKeys<span class="gly">[</span>i<span class="gly">]</span> = <span class="S">"`"</span> + primaryKeys<span class="gly">[</span>i<span class="gly">]</span> + <span class="S">"`"</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        sql.<span class="func">push</span>(<span class="S">"PRIMARY KEY ("</span> + primaryKeys.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">")"</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        sql.<span class="func">push</span>(<span class="S">'`id` INT(11) NOT NULL AUTO_INCREMENT UNIQUE PRIMARY KEY'</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> foreignKeys = this._models<span class="gly">[</span>model<span class="gly">]</span>.settings.foreignKeys <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    foreignKeys = foreignKeys.<span class="func">slice</span>(0);</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span>(foreignKeys.length) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">for</span>(<span class="kwrd">var</span> i = 0, length = foreignKeys.length; i &lt; length; i ++) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> foreignKey = foreignKeys<span class="gly">[</span>i<span class="gly">]</span>;</code><span class="hits">1</span></li><li class="covered"><code>            <span class="kwrd">var</span> str = <span class="S">"FOREIGN KEY (`"</span> + foreignKeys<span class="gly">[</span>i<span class="gly">]</span>.localCol + <span class="S">"`) REFERENCES "</span> + foreignKey.foreignTable + <span class="S">"(`"</span> + foreignKey.foreignCol + <span class="S">"`)"</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span>(foreignKey.onDelete) <span class="gly">{</span></code></li><li class="covered"><code>                str += <span class="S">" ON DELETE CASCADE"</span>;</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span>(foreignKey.onUpdate) <span class="gly">{</span></code></li><li class="covered"><code>                str += <span class="S">" ON UPDATE CASCADE"</span>;</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>            sql.<span class="func">push</span>(str);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> sql.jo<span class="kwrd">in</span>(<span class="S">',\n  '</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.propertySettingsSQL = <span class="kwrd">function</span>(model, prop) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> p = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span>, field = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">13</span></li><li class=""><code></code></li><li class="covered"><code>    field.<span class="func">push</span>(<span class="func">datatype</span>(p));</code><span class="hits">13</span></li><li class="covered"><code>    field.<span class="func">push</span>(p.allowNull === false <span class="gly">|</span><span class="gly">|</span> (<span class="kwrd">typeof</span> p<span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span> !== <span class="S">'undefined'</span> &amp;&amp; <span class="func">acceptedDefaults</span>(p)) ? <span class="S">'NOT NULL'</span> : <span class="S">'NULL'</span>);</code><span class="hits">13</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> p<span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span> !== <span class="S">'undefined'</span> &amp;&amp; <span class="func">acceptedDefaults</span>(p) &amp;&amp; <span class="kwrd">typeof</span> p<span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span> !== <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        field.<span class="func">push</span>(<span class="S">'DEFAULT '</span> + <span class="func">getDefaultValue</span>(p));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (p.unique === true) <span class="gly">{</span>  </code></li><li class="uncovered"><code>        field.<span class="func">push</span>(<span class="S">'UNIQUE'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> field.jo<span class="kwrd">in</span>(<span class="S">" "</span>);</code><span class="hits">13</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">datatype</span>(p) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> dt = <span class="S">''</span>;</code><span class="hits">139</span></li><li class=""><code>    <span class="kwrd">switch</span> ((p.type.name <span class="gly">|</span><span class="gly">|</span> <span class="S">'string'</span>).toLower<span class="kwrd">Case</span>()) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'string'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'varchar'</span>:</code></li><li class="covered"><code>            dt = <span class="S">'VARCHAR('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 255) + <span class="S">')'</span>;</code><span class="hits">56</span></li><li class="covered"><code>            <span class="kwrd">break</span>;</code><span class="hits">56</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'json'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'text'</span>:</code></li><li class="covered"><code>            dt = <span class="S">'TEXT'</span>;</code><span class="hits">14</span></li><li class="covered"><code>            <span class="kwrd">break</span>;</code><span class="hits">14</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'number'</span>:</code></li><li class="covered"><code>            <span class="kwrd">var</span> ftype = (<span class="func">parseFloat</span>(p.limit) &gt; 11) ? <span class="S">"BIGINT"</span> : <span class="S">"INT"</span>;</code><span class="hits">41</span></li><li class="covered"><code>            dt = ftype + <span class="S">'('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 11) + <span class="S">')'</span>;</code><span class="hits">41</span></li><li class="covered"><code>            <span class="kwrd">break</span>;</code><span class="hits">41</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'date'</span>:</code></li><li class="covered"><code>            dt = <span class="S">'DATETIME'</span>;</code><span class="hits">14</span></li><li class="covered"><code>            <span class="kwrd">break</span>;</code><span class="hits">14</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'boolean'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'bool'</span>:</code></li><li class="covered"><code>            dt = <span class="S">'TINYINT('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 1) + <span class="S">')'</span>;</code><span class="hits">14</span></li><li class="covered"><code>            <span class="kwrd">break</span>;</code><span class="hits">14</span></li><li class=""><code>        default:</code></li><li class="uncovered"><code>            dt = <span class="S">'VARCHAR('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 255) + <span class="S">')'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> dt;</code><span class="hits">139</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.buildWhere = <span class="kwrd">function</span> <span class="func">buildWhere</span>(conds, adapter, model) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> cs = <span class="gly">[</span><span class="gly">]</span>, or = <span class="gly">[</span><span class="gly">]</span>,</code></li><li class=""><code>            self = adapter,</code></li><li class="uncovered"><code>            props = self._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(conds).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (key !== <span class="S">'or'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            cs = <span class="func">parseCond</span>(cs, key, props, conds, self);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            conds<span class="gly">[</span>key<span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(oconds) <span class="gly">{</span></code></li><li class=""><code>                Object.<span class="func">keys</span>(oconds).<span class="func">forEach</span>(<span class="kwrd">function</span>(okey) <span class="gly">{</span></code></li><li class="uncovered"><code>                    or = <span class="func">parseCond</span>(or, okey, props, oconds, self);</code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (cs.length === 0 &amp;&amp; or.length === 0) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="S">''</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> orop = <span class="S">""</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (or.length) <span class="gly">{</span></code></li><li class="uncovered"><code>        orop = <span class="S">' ('</span> + or.jo<span class="kwrd">in</span>(<span class="S">' OR '</span>) + <span class="S">') '</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    orop += (orop !== <span class="S">""</span> &amp;&amp; cs.length &gt; 0) ? <span class="S">' AND '</span> : <span class="S">''</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'WHERE '</span> + orop + cs.jo<span class="kwrd">in</span>(<span class="S">' AND '</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">parseCond</span>(cs, key, props, conds, self) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> keyEscaped = <span class="S">'`'</span> + key.<span class="func">replace</span>(/\./g, <span class="S">'`.`'</span>) + <span class="S">'`'</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> val = self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, conds<span class="gly">[</span>key<span class="gly">]</span>);</code></li><li class=""><code>    <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span> === null) <span class="gly">{</span></code></li><li class="uncovered"><code>        cs.<span class="func">push</span>(keyEscaped + <span class="S">' IS NULL'</span>);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span>.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(conds<span class="gly">[</span>key<span class="gly">]</span>).<span class="func">forEach</span>(<span class="kwrd">function</span>(condType) <span class="gly">{</span></code></li><li class="uncovered"><code>            val = self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, conds<span class="gly">[</span>key<span class="gly">]</span><span class="gly">[</span>condType<span class="gly">]</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> sqlCond = keyEscaped;</code></li><li class=""><code>            <span class="kwrd">if</span> ((condType === <span class="S">'inq'</span> <span class="gly">|</span><span class="gly">|</span> condType === <span class="S">'nin'</span>) &amp;&amp; val.length === 0) <span class="gly">{</span></code></li><li class="uncovered"><code>                cs.<span class="func">push</span>(condType === <span class="S">'inq'</span> ? 0 : 1);</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> true;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">switch</span> (condType) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'gt'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' &gt; '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'gte'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' &gt;= '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'lt'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' &lt; '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'lte'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' &lt;= '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'between'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' BETWEEN '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'inq'</span>:</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'in'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' IN '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'nin'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' NOT IN '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'neq'</span>:</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'ne'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' != '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'regex'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' REGEXP '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'like'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' LIKE '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'nlike'</span>:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' NOT LIKE '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>                default:</code></li><li class="uncovered"><code>                    sqlCond += <span class="S">' '</span> + condType + <span class="S">' '</span>;</code></li><li class="uncovered"><code>                    <span class="kwrd">break</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            sqlCond += (condType === <span class="S">'in'</span> <span class="gly">|</span><span class="gly">|</span> condType === <span class="S">'inq'</span> <span class="gly">|</span><span class="gly">|</span> condType === <span class="S">'nin'</span>) ? <span class="S">'('</span> + val + <span class="S">')'</span> : val;</code></li><li class="uncovered"><code>            cs.<span class="func">push</span>(sqlCond);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (/^\<span class="C">//gi.test(conds[key])) {</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> reg = val.<span class="func">toString</span>().<span class="func">split</span>(<span class="S">'/'</span>);</code></li><li class="uncovered"><code>        cs.<span class="func">push</span>(keyEscaped + <span class="S">' REGEXP "'</span> + reg<span class="gly">[</span>1<span class="gly">]</span> + <span class="S">'"'</span>);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        cs.<span class="func">push</span>(keyEscaped + <span class="S">' = '</span> + val);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> cs;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.buildOrderBy = <span class="kwrd">function</span> <span class="func">buildOrderBy</span>(order) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> order === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        order = <span class="gly">[</span>order<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'ORDER BY '</span> + order.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.buildLimit = <span class="kwrd">function</span> <span class="func">buildLimit</span>(limit, offset) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'LIMIT '</span> + (offset ? (offset + <span class="S">', '</span> + limit) : limit);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.<span class="kwrd">prototype</span>.buildGroupBy = <span class="kwrd">function</span> <span class="func">buildGroupBy</span>(group) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> group === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        group = <span class="gly">[</span>group<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'GROUP BY '</span> + group.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">acceptedDefaults</span>(prop) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (/^INT<span class="gly">|</span>^BIGINT<span class="gly">|</span>^<span class="kwrd">VAR</span><span class="gly">|</span>^TINY/i.<span class="func">test</span>(<span class="func">datatype</span>(prop))) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> true;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> false;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getDefaultValue</span>(prop) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (/^INT<span class="gly">|</span>^BIGINT/i.<span class="func">test</span>(prop.Type <span class="gly">|</span><span class="gly">|</span> <span class="func">datatype</span>(prop))) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">parseInt</span>(prop<span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> prop<span class="gly">[</span><span class="S">'Default'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> 0);</code><span class="hits">26</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (/^TINY/i.<span class="func">test</span>(prop.Type <span class="gly">|</span><span class="gly">|</span> <span class="func">datatype</span>(prop))) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> prop<span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> prop<span class="gly">[</span><span class="S">'Default'</span><span class="gly">]</span> ? 1 : 0;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="S">"'"</span> + (prop<span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> prop<span class="gly">[</span><span class="S">'Default'</span><span class="gly">]</span>) + <span class="S">"'"</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-adapters-memory-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-adapters-memory-js" class="filename trigger" name="lib-adapters-memory-js">lib/adapters/memory.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 52%"><strong>52%</strong> [48/93]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'../utils'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> helpers = utils.helpers;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">Memory</span>();</code><span class="hits">2</span></li><li class="covered"><code>    process.<span class="func">nextTick</span>(callback);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Memory</span>() <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    this.cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    this.ids = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.define = <span class="kwrd">function</span> <span class="func">defineModel</span>(descr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> m = descr.model.modelName;</code><span class="hits">3</span></li><li class="covered"><code>    this._models<span class="gly">[</span>m<span class="gly">]</span> = descr;</code><span class="hits">3</span></li><li class="covered"><code>    this.cache<span class="gly">[</span>m<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>    this.ids<span class="gly">[</span>m<span class="gly">]</span> = 1;</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.toDatabase = <span class="kwrd">function</span>(model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cleaned = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class="covered"><code>       cleaned<span class="gly">[</span>key<span class="gly">]</span> = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">73</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">8</span></li><li class="covered"><code>    <span class="kwrd">return</span> cleaned;</code><span class="hits">8</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.create = <span class="kwrd">function</span> <span class="func">create</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> id = data.id <span class="gly">|</span><span class="gly">|</span> this.ids<span class="gly">[</span>model<span class="gly">]</span>++;</code><span class="hits">8</span></li><li class="covered"><code>    data.id = id;</code><span class="hits">8</span></li><li class="covered"><code>    this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span> = this.<span class="func">toDatabase</span>(model, data);</code><span class="hits">8</span></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(null, id);</code><span class="hits">8</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">8</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.updateOrCreate = <span class="kwrd">function</span>(model, data, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> mem = this;</code></li><li class=""><code>    this.<span class="func">exists</span>(model, data.id, <span class="kwrd">function</span>(err, exists) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (exists) <span class="gly">{</span></code></li><li class="uncovered"><code>            mem.<span class="func">save</span>(model, data, callback);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            mem.<span class="func">create</span>(model, data, <span class="kwrd">function</span>(err, id) <span class="gly">{</span></code></li><li class="uncovered"><code>                data.id = id;</code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, data);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.save = <span class="kwrd">function</span> <span class="func">save</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>data.id<span class="gly">]</span> = data;</code><span class="hits">4</span></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(null, data);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.exists = <span class="kwrd">function</span> <span class="func">exists</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(null, this.cache<span class="gly">[</span>model<span class="gly">]</span>.<span class="func">hasOwnProperty</span>(id));</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.findById = <span class="kwrd">function</span> <span class="func">findById</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(null, this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    delete this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">1</span></li><li class="covered"><code>    process.<span class="func">nextTick</span>(callback);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.remove = <span class="kwrd">function</span> <span class="func">remove</span>(model, filter, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class=""><code>    self.<span class="func">all</span>(model, filter, <span class="kwrd">function</span>(err, nodes) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> count = nodes.length;</code></li><li class=""><code>        <span class="kwrd">if</span> (count &gt; 0) <span class="gly">{</span></code></li><li class=""><code>            nodes.<span class="func">forEach</span>(<span class="kwrd">function</span>(node) <span class="gly">{</span></code></li><li class="uncovered"><code>                delete self.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>node.id<span class="gly">]</span>;</code></li><li class=""><code>                <span class="kwrd">if</span> (--count === 0) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">callback</span>();</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="S">'function'</span> === <span class="kwrd">typeof</span> filter) <span class="gly">{</span></code></li><li class="uncovered"><code>        callback = filter;</code></li><li class="uncovered"><code>        filter = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!filter) <span class="gly">{</span></code></li><li class="uncovered"><code>        filter = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">var</span> nodes = Object.<span class="func">keys</span>(this.cache<span class="gly">[</span>model<span class="gly">]</span>).<span class="func">map</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">10</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">8</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// do we need some filtration?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class="covered"><code>            nodes = nodes ? nodes.<span class="func">filter</span>(helpers.<span class="func">applyFilter</span>(filter)) : nodes;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// do we need some sorting?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> orders = filter.order;</code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.order === <span class="S">"string"</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                orders = <span class="gly">[</span>filter.order<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            orders.<span class="func">forEach</span>(<span class="kwrd">function</span>(key, i) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> reverse = 1;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> m = key.<span class="func">match</span>(/\s+(A<span class="gly">|</span>DE)SC$/i);</code></li><li class=""><code>                <span class="kwrd">if</span> (m) <span class="gly">{</span></code></li><li class="uncovered"><code>                    key = key.<span class="func">replace</span>(/\s+(A<span class="gly">|</span>DE)SC/i, <span class="S">''</span>);</code></li><li class=""><code>                    <span class="kwrd">if</span> (m<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'DE'</span>)</code></li><li class="uncovered"><code>                        reverse = -1;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                orders<span class="gly">[</span>i<span class="gly">]</span> = <span class="gly">{</span><span class="S">"key"</span>: key, <span class="S">"reverse"</span>: reverse<span class="gly">}</span>;</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>            nodes = nodes.<span class="func">sort</span>(sorting.<span class="func">bind</span>(orders));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(null, nodes);</code><span class="hits">8</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">sorting</span>(a, b) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0, l = this.length; i &lt; l; i++) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (a<span class="gly">[</span>this<span class="gly">[</span>i<span class="gly">]</span>.key<span class="gly">]</span> &gt; b<span class="gly">[</span>this<span class="gly">[</span>i<span class="gly">]</span>.key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">return</span> 1 * this<span class="gly">[</span>i<span class="gly">]</span>.reverse;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (a<span class="gly">[</span>this<span class="gly">[</span>i<span class="gly">]</span>.key<span class="gly">]</span> &lt; b<span class="gly">[</span>this<span class="gly">[</span>i<span class="gly">]</span>.key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">return</span> -1 * this<span class="gly">[</span>i<span class="gly">]</span>.reverse;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> 0;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(this.cache<span class="gly">[</span>model<span class="gly">]</span>).<span class="func">forEach</span>(<span class="kwrd">function</span>(id) <span class="gly">{</span></code></li><li class="uncovered"><code>        delete this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="uncovered"><code>    this.cache<span class="gly">[</span>model<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>    process.<span class="func">nextTick</span>(callback);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> cache = this.cache<span class="gly">[</span>model<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> data = Object.<span class="func">keys</span>(cache);</code></li><li class=""><code>    <span class="kwrd">if</span> (where) <span class="gly">{</span></code></li><li class=""><code>        data = data.<span class="func">filter</span>(<span class="kwrd">function</span>(id) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> ok = true;</code></li><li class=""><code>            Object.<span class="func">keys</span>(where).<span class="func">forEach</span>(<span class="kwrd">function</span>(key) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (cache<span class="gly">[</span>id<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span> !== where<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    ok = false;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> ok;</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(null, data.length);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.<span class="kwrd">prototype</span>.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttributes</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class="covered"><code>    data.id = id;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> base = this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">3</span></li><li class="covered"><code>    this.<span class="func">save</span>(model, helpers.<span class="func">merge</span>(base, data), cb);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li></ol></pre></div></div>
        </div>
    </body>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="bootstrap.js"></script>
    <script type="text/javascript" src="coverage.js"></script>
</html>

